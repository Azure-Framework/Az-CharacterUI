<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Azure Framework — Character Select (NUI)</title>
  <meta name="description" content="Azure Framework character select NUI" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
  <style>
    /* ---------- Base / Layout ---------- */
    :root{
      --bg-0:#041027; --bg-1:#051226;
      --muted:#97b8d9; --accent:#2ea0ff; --accent-2:#2b7be9;
      --radius:14px; --transition:200ms cubic-bezier(.2,.9,.25,1);
      font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
      --max-ui-width:1200px;
    }

    /* remove page scrollbar and ensure NUI occupies full viewport */
    html,body{height:100%;margin:0;color:#eaf6ff; -webkit-font-smoothing:antialiased;background:transparent;overflow:hidden;}
    *{box-sizing:border-box}

    /* Main background container is the only scrollable area if needed */
    .bg-container{
      height:100vh;
      width:100%;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:20px;
      background:
        radial-gradient(1200px 600px at 10% 10%, rgba(43,123,233,0.06), transparent),
        linear-gradient(180deg,var(--bg-0), var(--bg-1) 95%);
      opacity:0;
      transform:translateY(6px);
      transition:opacity 340ms ease, transform 340ms ease;
      pointer-events:none;
    }
    .bg-container.azfw-appeared{
      opacity:1;
      transform:none;
      pointer-events:auto;
    }

    /* central app grid */
    .app{
      width:100%;
      max-width:var(--max-ui-width);
      display:grid;
      grid-template-columns: minmax(300px,420px) 1fr;
      gap:20px;
      align-items:start;
      height:calc(100vh - 40px); /* account for padding */
      max-height:100%;
    }

    .panel{
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.02));
      border-radius:var(--radius);
      border:1px solid rgba(255,255,255,0.03);
      padding:16px;
      box-shadow: 0 12px 48px rgba(3,8,18,0.6);
      display:flex;
      flex-direction:column;
      min-height:0; /* important for children to scroll */
    }
    .panel.animated{animation:panel-in 420ms var(--transition) both}
    @keyframes panel-in{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:none}}

    /* ---------- LEFT COLUMN ---------- */
    .left{display:flex;flex-direction:column;gap:12px;min-height:0;}

    /* header sits in a flexible layout; allow wrapping so brand doesn't get squished */
    .header{
      display:flex;
      align-items:center;
      gap:12px;
      width:100%;
      min-width:0;
      flex-wrap:wrap;
    }

    /* logo sits in its box but brand-text isn't squeezed */
    .logo{
      width:56px;height:56px;border-radius:50%;
      background:linear-gradient(135deg,var(--accent),var(--accent-2));
      display:flex;align-items:center;justify-content:center;
      font-weight:800;color:white;font-size:18px;flex:0 0 56px;
      min-width:56px;
    }

    /* brand-text flexes and can grow — not squished, prefers a sensible baseline */
    .brand-text{
      display:flex;
      flex-direction:column;
      min-width:0;
      /* prefer to take available space, but allow it to shrink if needed */
      flex: 1 1 220px;
      margin-right:8px;
    }

    /* prevent mid-word wrapping and use ellipsis when there's not enough space */
    .brand-text h1{
      margin:0;
      font-size:18px;
      line-height:1.05;
      white-space:nowrap;         /* don't break inside words */
      overflow:hidden;            /* hide overflow */
      text-overflow:ellipsis;     /* show ellipsis if truncated */
      padding-right:6px;
    }
    /* subtitle allowed to wrap normally but won't force the title to break */
    .brand-text p{margin:0;color:var(--muted);font-size:13px;white-space:normal;word-break:normal;overflow:visible}

    /* Keep controls anchored but allow them to move to next line on very narrow widths */
    .header-right{display:flex;gap:10px;align-items:center;flex:0 0 auto;margin-left:auto}
    .search{flex:0 1 180px;min-width:80px;max-width:260px;padding:10px 12px;border-radius:10px;border:1px solid rgba(255,255,255,0.03);background:transparent;color:inherit}
    .btn-ghost{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--muted);padding:8px 12px;border-radius:8px;cursor:pointer}

    .cards-wrap{background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.00));border-radius:12px;padding:10px;border:1px solid rgba(255,255,255,0.02);display:flex;flex-direction:column;flex:1 1 auto;min-height:0}
    /* card-list can scroll internally; hide visual scrollbar for cleaner look */
    .card-list{display:flex;flex-direction:column;gap:10px;overflow:auto;padding:6px;min-height:0}
    .card-list::-webkit-scrollbar{width:0;height:0}
    .card-list{ -ms-overflow-style:none; scrollbar-width:none; }

    .card{display:flex;align-items:center;gap:12px;padding:10px;border-radius:12px;background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.00));border:1px solid rgba(255,255,255,0.03);cursor:pointer;transition:transform var(--transition),box-shadow var(--transition),background 220ms;min-height:68px}
    .card:hover{transform:translateY(-4px);box-shadow:0 14px 40px rgba(3,8,18,0.45);}
    .card.selected{outline:2px solid rgba(46,160,255,0.14);box-shadow:0 22px 60px rgba(43,123,233,0.10)}
    .card.entrance{animation:card-pop 320ms cubic-bezier(.2,.9,.25,1) both}
    @keyframes card-pop{from{opacity:0;transform:translateY(8px) scale(.99)}to{opacity:1;transform:none}}

    .avatar{width:44px;height:44px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700;color:var(--accent);background:linear-gradient(135deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01));border:1px solid rgba(255,255,255,0.03);font-size:16px;flex:0 0 44px}
    .meta{min-width:0;flex:1 1 auto}
    .meta h3{margin:0;font-size:15px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .meta p{margin:6px 0 0 0;color:var(--muted);font-size:13px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

    .card-right{margin-left:auto;display:flex;flex-direction:column;gap:6px;align-items:flex-end}
    .stat-pill{background:rgba(255,255,255,0.01);padding:6px 10px;border-radius:8px;color:var(--muted);font-size:13px}

    .create-large{margin-top:8px;padding:12px;border-radius:28px;background:linear-gradient(90deg,var(--accent),var(--accent-2));color:#fff;font-weight:700;border:none;cursor:pointer;box-shadow:0 16px 40px rgba(43,123,233,0.18);width:100%;transition:transform var(--transition);}
    .create-large:hover{transform:translateY(-3px)}

    /* ---------- RIGHT / PREVIEW ---------- */
    .preview-panel{display:flex;flex-direction:column;gap:14px;flex:1 1 auto;min-height:0}
    .viewport{flex:0 0 auto;height:40vh;min-height:160px;max-height:420px;border-radius:12px;background:linear-gradient(180deg,#072033,#041225);display:flex;align-items:center;justify-content:center;border:1px solid rgba(255,255,255,0.03);overflow:hidden}
    .big-avatar{width:100%;height:100%;display:flex;align-items:center;justify-content:center;font-size:clamp(56px,12vw,140px);font-weight:900;color:var(--accent);transition:transform 420ms cubic-bezier(.2,.9,.25,1)}
    .big-avatar.float{animation:floaty 4s ease-in-out infinite}
    @keyframes floaty{0%{transform:translateY(0)}50%{transform:translateY(-6px)}100%{transform:translateY(0)}}

    .info-row{display:flex;gap:16px;align-items:flex-start}
    .meta-side{flex:1;display:flex;flex-direction:column;gap:12px}
    .player-name{font-weight:800;font-size:20px;line-height:1}
    .player-sub{color:var(--muted)}
    .pills{display:flex;gap:8px;flex-wrap:wrap}
    .pill{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.02);display:flex;justify-content:space-between;align-items:center;min-width:96px}
    .actions{display:flex;gap:8px;flex-wrap:wrap}
    .btn-primary{background:linear-gradient(90deg,var(--accent),var(--accent-2));color:white;font-weight:700;padding:10px 14px;border-radius:8px;border:none;cursor:pointer}

    pre#detailBox{background:rgba(255,255,255,0.01);padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.02);min-height:140px;color:var(--muted);white-space:pre-wrap;overflow:auto;max-height:22vh}
    pre#detailBox::-webkit-scrollbar{width:0;height:0}
    pre#detailBox{ -ms-overflow-style:none; scrollbar-width:none; }

    /* accessibility outlines */
    .card:focus{outline:2px dashed rgba(46,160,255,0.12);outline-offset:3px}
    button:focus{outline:2px solid rgba(46,160,255,0.16);outline-offset:3px}

    /* ---------- Modals / Toast ---------- */
    .modal-backdrop{position:fixed;inset:0;background:linear-gradient(180deg, rgba(0,0,0,0.5), rgba(0,0,0,0.4));display:flex;align-items:center;justify-content:center;z-index:1200;opacity:0;pointer-events:none;transition:opacity 180ms ease}
    .modal-backdrop.visible{opacity:1;pointer-events:auto}
    .modal{width:100%;max-width:520px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.02));border-radius:12px;padding:16px;border:1px solid rgba(255,255,255,0.04);box-shadow:0 18px 60px rgba(0,0,0,0.6)}
    .modal h3{margin:0 0 8px 0}
    .modal .row{display:flex;gap:8px;margin-top:8px}
    .modal input[type="text"]{flex:1;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit}
    .modal .buttons{display:flex;gap:8px;justify-content:flex-end;margin-top:12px}
    .modal .btn{padding:10px 12px;border-radius:8px;border:none;cursor:pointer}
    .btn-cancel{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--muted)}
    .btn-save{background:linear-gradient(90deg,var(--accent),var(--accent-2));color:white;font-weight:700}
    .modal .hint{color:var(--muted);font-size:13px;margin-top:6px}
    .delete-msg{padding:8px 0;color:var(--muted)}

    .toast-wrap{position:fixed;right:18px;bottom:18px;z-index:1400;display:flex;flex-direction:column;gap:8px;align-items:flex-end}
    .toast{background:rgba(0,0,0,0.6);padding:10px 14px;border-radius:10px;color:#eaf6ff;border:1px solid rgba(255,255,255,0.03);box-shadow:0 6px 24px rgba(3,8,18,0.5)}

    /* ---------- Hide native scrollbars globally for a cleaner NUI */
    ::-webkit-scrollbar{width:0; height:0}
    * { -ms-overflow-style: none; scrollbar-width: none; }

    /* ---------- Responsive tweaks ---------- */
    @media (max-width:980px){
      :root { --max-ui-width:960px; }
      .app{grid-template-columns:1fr; gap:14px; padding:0; }
      .viewport{height:34vh; max-height:360px}
      .brand-text h1{font-size:16px}
      .create-large{padding:10px}
      .panel{padding:12px}
      .search{max-width:160px}
    }

    @media (max-width:520px){
      .logo{width:48px;height:48px;flex:0 0 48px;font-size:16px}
      .brand-text h1{font-size:15px}
      .viewport{height:28vh;min-height:120px}
      .player-name{font-size:16px}
      .card{min-height:60px;padding:8px}
      .create-large{padding:10px;font-size:14px}
    }
  </style>
</head>
<body>
  <div class="bg-container" id="azfw-bg" role="application" aria-label="Azure Framework character UI">
    <div class="app" role="region" aria-label="Character selection app">

      <!-- LEFT -->
      <aside class="panel left animated" aria-label="Character selection">
        <div class="header">
          <div id="ui-logo" class="logo" aria-hidden="true">AZ</div>
          <div class="brand-text" title="">
            <h1 id="ui-brandTitle">Azure Framework</h1>
            <div id="ui-brandSubtitle" class="muted">All characters — choose or create</div>
          </div>

          <div class="header-right">
            <input id="azfw-search" class="search" placeholder="Search characters..." aria-label="Search characters">
            <button id="azfw-sort" class="btn-ghost" title="Sort">Sort</button>
          </div>
        </div>

        <div class="cards-wrap" aria-live="polite">
          <div class="card-list" id="charGrid" role="list"></div>

          <div style="display:flex;justify-content:space-between;align-items:center;margin-top:6px">
            <small class="muted">Press Enter to confirm selection</small>
            <small class="muted">redone</small>
          </div>

        </div>

        <button id="azfw-create" class="create-large" aria-haspopup="dialog">+  Create Character</button>
      </aside>

      <!-- CENTER / RIGHT -->
      <section class="panel preview-panel animated" aria-label="Preview">
        <div class="viewport" aria-hidden="false">
          <div id="azfw-preview" class="big-avatar float" aria-hidden="true">A</div>
        </div>

        <div class="info-row">
          <div class="meta-side">
            <div>
              <div id="azfw-metaName" class="player-name">No character selected</div>
              <div id="azfw-metaDesc" class="player-sub">Select a character on the left or create one.</div>
            </div>

            <div class="pills" role="group" aria-label="Character stats">
              <div class="pill">Health <strong id="azfw-health">—</strong></div>
              <div class="pill">Armor <strong id="azfw-armor">—</strong></div>
              <div class="pill">Cash <strong id="azfw-cash">—</strong></div>
            </div>

            <div class="actions" role="group">
              <button id="azfw-start" class="btn-primary">Start</button>
              <button id="azfw-edit" class="btn-ghost">Edit</button>
              <button id="azfw-delete" class="btn-ghost">Delete</button>
            </div>
          </div>
        </div>

        <div style="flex:1 1 auto;min-height:0">
          <h4 style="margin:0 0 6px 0">Character Details</h4>
          <pre id="azfw-detailBox">No selection — click a character to view more</pre>
        </div>
      </section>

    </div>
  </div>

  <!-- Create / Edit Modal -->
  <div id="modal-create" class="modal-backdrop" aria-hidden="true" tabindex="-1">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modal-create-title">
      <h3 id="modal-create-title">Create Character</h3>
      <div class="hint">Fill out the name fields and save. This stays inside the NUI.</div>

      <div class="row" style="margin-top:12px">
        <input id="modal-first" type="text" placeholder="First name" autocomplete="off" aria-label="First name">
        <input id="modal-last" type="text" placeholder="Last name" autocomplete="off" aria-label="Last name">
      </div>

      <div class="buttons">
        <button id="modal-create-cancel" class="btn btn-cancel">Cancel</button>
        <button id="modal-create-save" class="btn btn-save">Save</button>
      </div>
    </div>
  </div>

  <!-- Delete confirmation modal -->
  <div id="modal-delete" class="modal-backdrop" aria-hidden="true" tabindex="-1">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modal-delete-title">
      <h3 id="modal-delete-title">Delete character</h3>
      <div class="delete-msg" id="modal-delete-msg">Are you sure you want to delete this character?</div>

      <div class="buttons">
        <button id="modal-delete-cancel" class="btn btn-cancel">Cancel</button>
        <button id="modal-delete-confirm" class="btn btn-save">Delete</button>
      </div>
    </div>
  </div>

  <!-- toast -->
  <div class="toast-wrap" id="toastWrap" aria-live="polite" aria-atomic="true"></div>

  <!-- config (load before main script) -->
  <script src="config.js"></script>

  <script>
    /********* APPLY CONFIG (logo, brand, colors) *********/
    (function(){
      const DEFAULT_CONFIG = {
        logoText: 'AZ',
        brandTitle: 'Azure Framework',
        brandSubtitle: 'All characters — choose or create',
        colors: {
          accent: '#2ea0ff',
          accent2: '#2b7be9',
          bg0: '#041027',
          bg1: '#051226',
          muted: '#97b8d9'
        }
      };

      const userCfg = (window && window.AZFW_CONFIG) ? window.AZFW_CONFIG : {};
      const cfg = {
        logoText: userCfg.logoText ?? DEFAULT_CONFIG.logoText,
        brandTitle: userCfg.brandTitle ?? DEFAULT_CONFIG.brandTitle,
        brandSubtitle: userCfg.brandSubtitle ?? DEFAULT_CONFIG.brandSubtitle,
        colors: Object.assign({}, DEFAULT_CONFIG.colors, userCfg.colors || {})
      };

      // Apply CSS variables early
      const root = document.documentElement;
      if (cfg.colors) {
        root.style.setProperty('--accent', cfg.colors.accent);
        root.style.setProperty('--accent-2', cfg.colors.accent2);
        root.style.setProperty('--bg-0', cfg.colors.bg0);
        root.style.setProperty('--bg-1', cfg.colors.bg1);
        root.style.setProperty('--muted', cfg.colors.muted);
      }

      // Apply text into DOM on DOMContentLoaded
      document.addEventListener('DOMContentLoaded', () => {
        const logoEl = document.getElementById('ui-logo');
        const titleEl = document.getElementById('ui-brandTitle');
        const subEl = document.getElementById('ui-brandSubtitle');

        if (logoEl) logoEl.textContent = String(cfg.logoText ?? DEFAULT_CONFIG.logoText);
        if (titleEl) titleEl.textContent = String(cfg.brandTitle ?? DEFAULT_CONFIG.brandTitle);
        if (subEl) subEl.textContent = String(cfg.brandSubtitle ?? DEFAULT_CONFIG.brandSubtitle);

        // set the brand-text title attribute (full text on hover for long titles)
        const brandWrap = document.querySelector('.brand-text');
        if (brandWrap) brandWrap.setAttribute('title', (cfg.brandTitle + ' — ' + cfg.brandSubtitle).trim());
      });

      // expose current config for debugging
      window._AZFW_ACTIVE_CONFIG = cfg;
    })();
  </script>

  <script>
    /********* MAIN UI LOGIC (characters, modals, posts) *********/
    (function(){
      // RESOURCE is set dynamically by the client when UI opens
      let RESOURCE = null;

      const bg = document.getElementById('azfw-bg');

      window.addEventListener('message', (ev) => {
        const d = ev.data || {};
        if (!d.type) return;

        if (d.type === 'azfw_set_resource') {
          RESOURCE = d.resource || RESOURCE;
          return;
        }

        if (d.type === 'azfw_open_ui') {
          showUI();
          if (Array.isArray(d.chars)) loadCharacters(d.chars);
        } else if (d.type === 'azfw_update_chars') {
          if (Array.isArray(d.chars)) loadCharacters(d.chars);
        } else if (d.type === 'azfw_close_ui') {
          hideUI();
        }
      });

      function postToLua(endpoint, payload = {}) {
        if (!RESOURCE) {
          console.warn('azfw NUI: RESOURCE not set yet; endpoint=', endpoint, 'payload=', payload);
          return Promise.resolve(null);
        }
        return fetch(`https://${RESOURCE}/${endpoint}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json; charset=UTF-8' },
          body: JSON.stringify(payload)
        }).then(r => {
          return r.text().then(text => {
            try { return text ? JSON.parse(text) : null; } catch (e) { return text || null; }
          });
        }).catch(e => { console.error('NUI->Lua fetch error', e); return null; });
      }

      const get = id => document.getElementById(id);

      const gridId = 'charGrid';
      const preview = get('azfw-preview');
      const nameEl = get('azfw-metaName');
      const descEl = get('azfw-metaDesc');
      const healthEl = get('azfw-health');
      const armorEl = get('azfw-armor');
      const cashEl = get('azfw-cash');
      const detailEl = get('azfw-detailBox');

      const modalCreate = get('modal-create');
      const modalDelete = get('modal-delete');
      const modalFirst = get('modal-first');
      const modalLast = get('modal-last');
      const createSaveBtn = get('modal-create-save');
      const createCancelBtn = get('modal-create-cancel');
      const deleteConfirmBtn = get('modal-delete-confirm');
      const deleteCancelBtn = get('modal-delete-cancel');
      const toastWrap = get('toastWrap');

      let state = { characters: [], selectedId: null };
      let pendingEditId = null;
      let pendingDeleteId = null;

      function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[c])); }

      function showUI(){
        bg.classList.add('azfw-appeared');
        setTimeout(()=> {
          const s = get('azfw-search');
          if (s) s.focus();
        }, 60);
      }
      function hideUI(){
        bg.classList.remove('azfw-appeared');
      }

      function loadCharacters(chars){
        state.characters = Array.isArray(chars) ? chars.slice() : [];
        state.selectedId = state.selectedId && state.characters.find(c => c.charid === state.selectedId) ? state.selectedId : (state.characters[0] ? state.characters[0].charid : null);
        renderGrid();
        if (state.selectedId) selectCharacter(state.selectedId, {silent:true});
      }

      function renderGrid(filter=''){
        const grid = get(gridId);
        if (!grid) { console.warn('charGrid element missing'); return; }
        grid.innerHTML = '';
        const chars = state.characters.filter(c => (c.name || '').toLowerCase().includes(String(filter).toLowerCase()));
        if (!chars.length) {
          const empty = document.createElement('div');
          empty.className = 'card';
          empty.innerHTML = '<div style="padding:20px;color:var(--muted)">No characters</div>';
          grid.appendChild(empty);
          return;
        }
        chars.forEach((c, i) => {
          const el = document.createElement('div');
          el.className = 'card' + (state.selectedId === c.charid ? ' selected' : '');
          el.tabIndex = 0;
          const avatarLetter = (c.name || '?').charAt(0).toUpperCase();

          const cashHtml = (c.cash !== null && c.cash !== undefined) ? ('$' + escapeHtml(String(c.cash))) : '—';

          el.innerHTML = `
            <div class="avatar">${escapeHtml(avatarLetter)}</div>
            <div class="meta">
              <h3>${escapeHtml(c.name || 'Unknown')}</h3>
              <p title="${escapeHtml((c.gender||'') + (c.age ? ' • ' + c.age + ' years' : ''))}">${escapeHtml(c.gender || '')} ${c.age ? ' • ' + escapeHtml(String(c.age)) + ' years' : ''}</p>
            </div>
            <div class="card-right">
              <div class="stat-pill">HP ${escapeHtml(String(c.health != null ? c.health : '—'))}</div>
              <div class="stat-pill">${cashHtml}</div>
            </div>
          `;
          // CLICK selects only (does NOT enter)
          el.addEventListener('click', () => {
            selectCharacter(c.charid);
          });
          el.addEventListener('keydown', e => { if (e.key === 'Enter') { e.preventDefault(); selectCharacter(c.charid); } });
          setTimeout(()=> el.classList.add('entrance'), 20 * i);
          grid.appendChild(el);
        });
      }

      function selectCharacter(charid, opts = {}) {
        const c = state.characters.find(x => x.charid === charid);
        if (!c) return;
        state.selectedId = charid;
        preview.textContent = (c.name || '?').charAt(0).toUpperCase();
        nameEl.textContent = c.name || 'Unknown';
        descEl.textContent = (c.gender || '') + (c.age ? ' • ' + c.age + ' years' : '');
        healthEl.textContent = c.health != null ? c.health : '—';
        armorEl.textContent = c.armor != null ? c.armor : '—';
        cashEl.textContent = c.cash != null ? ('$' + c.cash) : '—';
        detailEl.textContent = `ID: ${c.charid}\nName: ${c.name}\nGender: ${c.gender || '-'}\nAge: ${c.age || '-'}\nHealth: ${c.health || '-'}\nArmor: ${c.armor || '-'}\nCash: ${c.cash != null ? '$' + c.cash : '-'}`;
        renderGrid(get('azfw-search').value || '');
        preview.style.transform = 'scale(0.96)';
        setTimeout(()=> preview.style.transform = '', 120);
      }

      // modal helpers
      function openModal(modal) {
        modal.classList.add('visible');
        modal.setAttribute('aria-hidden','false');
      }
      function closeModal(modal) {
        modal.classList.remove('visible');
        modal.setAttribute('aria-hidden','true');
      }

      function showCreateEditModal(mode='create', character) {
        pendingEditId = mode === 'edit' ? (character && character.charid) : null;
        document.getElementById('modal-create-title').textContent = mode === 'edit' ? 'Edit Character' : 'Create Character';
        const firstVal = character ? (character.firstname || (character.name ? character.name.split(' ')[0] : '')) : 'New';
        const lastVal  = character ? (character.lastname || (character.name ? character.name.split(' ').slice(1).join(' ') : 'Citizen')) : 'Citizen';
        modalFirst.value = firstVal;
        modalLast.value = lastVal;
        openModal(modalCreate);
        setTimeout(()=> modalFirst.focus(), 40);
      }

      function showDeleteModal(charid) {
        pendingDeleteId = charid;
        const c = state.characters.find(x => x.charid === charid);
        const name = c ? (c.name || 'Unknown') : 'Unknown';
        document.getElementById('modal-delete-msg').textContent = `Delete "${name}" — this action cannot be undone.`;
        openModal(modalDelete);
        setTimeout(()=> deleteCancelBtn.focus(), 40);
      }

      function showToast(msg, ttl = 2200) {
        const t = document.createElement('div');
        t.className = 'toast';
        t.textContent = msg;
        toastWrap.appendChild(t);
        setTimeout(()=> {
          t.style.opacity = '0';
          t.style.transform = 'translateY(6px)';
        }, ttl - 260);
        setTimeout(()=> t.remove(), ttl);
      }

      // Create button opens modal
      get('azfw-create').addEventListener('click', () => {
        showCreateEditModal('create', null);
      });

      // Edit opens modal prefilled
      get('azfw-edit').addEventListener('click', () => {
        if (!state.selectedId) { showToast('Select a character to edit'); return; }
        const c = state.characters.find(x => x.charid === state.selectedId);
        showCreateEditModal('edit', c);
      });

      // Delete opens delete modal
      get('azfw-delete').addEventListener('click', () => {
        if (!state.selectedId) { showToast('Select a character to delete'); return; }
        showDeleteModal(state.selectedId);
      });

      // Save from create/edit modal
      createSaveBtn.addEventListener('click', () => {
        const first = modalFirst.value && modalFirst.value.trim();
        const last = modalLast.value && modalLast.value.trim();
        if (!first) { showToast('First name is required'); modalFirst.focus(); return; }
        const payload = { first, last };
        if (pendingEditId) payload.editCharId = pendingEditId;
        postToLua('azfw_create_character', payload).then(resp => {
          showToast(pendingEditId ? 'Character updated' : 'Character created');
          closeModal(modalCreate);
          pendingEditId = null;
        }).catch(() => {
          showToast('Failed to save character');
        });
      });

      createCancelBtn.addEventListener('click', () => {
        pendingEditId = null;
        closeModal(modalCreate);
      });

      // Delete confirm
      deleteConfirmBtn.addEventListener('click', () => {
        if (!pendingDeleteId) { closeModal(modalDelete); return; }
        postToLua('azfw_delete_character', { charid: pendingDeleteId }).then(resp => {
          showToast('Character deleted');
          closeModal(modalDelete);
          pendingDeleteId = null;
        }).catch(() => {
          showToast('Failed to delete character');
        });
      });
      deleteCancelBtn.addEventListener('click', () => {
        pendingDeleteId = null;
        closeModal(modalDelete);
      });

      // START: send selectedId to lua (this is the only action that "enters")
      get('azfw-start').addEventListener('click', () => {
        if (!state.selectedId) { showToast('Select a character to start'); return; }
        postToLua('azfw_select_character', { charid: state.selectedId }).then(()=> {});
      });

      // search & sort
      get('azfw-search').addEventListener('input', (e) => renderGrid(e.target.value));
      get('azfw-sort').addEventListener('click', () => {
        state.characters.sort((a,b) => {
          const ai = parseInt(a.charid || '') || 0; const bi = parseInt(b.charid || '') || 0;
          if (ai && bi) return bi - ai;
          return (b.name||'').localeCompare(a.name||'');
        });
        renderGrid(get('azfw-search').value || '');
      });

      // keyboard: Enter starts (unless in input), + opens create, Esc closes modals or UI
      window.addEventListener('keydown', (e) => {
        const active = document.activeElement;
        const isInput = active && (active.tagName === 'INPUT' || active.tagName === 'TEXTAREA');
        const inCard = active && typeof active.closest === 'function' && active.closest('.card');

        if (e.key === 'Enter') {
          if (!isInput && !inCard) {
            if (state.selectedId) postToLua('azfw_select_character', { charid: state.selectedId });
          }
        } else if (e.key === '+') {
          get('azfw-create').click();
        } else if (e.key === 'Escape') {
          // if modal open, close modal first; else close UI
          if (modalCreate.classList.contains('visible')) { closeModal(modalCreate); pendingEditId = null; }
          else if (modalDelete.classList.contains('visible')) { closeModal(modalDelete); pendingDeleteId = null; }
          else { postToLua('azfw_close_ui', {}).then(()=> hideUI()); }
        }
      });

      // modal click-outside
      modalCreate.addEventListener('click', (ev) => { if (ev.target === modalCreate) { closeModal(modalCreate); pendingEditId = null; } });
      modalDelete.addEventListener('click', (ev) => { if (ev.target === modalDelete) { closeModal(modalDelete); pendingDeleteId = null; } });

      // small API for client.lua
      window.azfw = {
        load: loadCharacters,
        hide: hideUI,
        show: showUI
      };

      // show bg-container now (client controls actual open)
      requestAnimationFrame(()=> bg.classList.add('azfw-appeared'));
    })();
  </script>
</body>
</html>

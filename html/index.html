<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Azure Framework — Character Select (NUI)</title>
  <meta name="description" content="Azure Framework character select NUI" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg-0:#041027; --bg-1:#051226;
      --muted:#97b8d9; --accent:#2ea0ff; --accent-2:#2b7be9;
      --radius:16px; --transition:220ms cubic-bezier(.2,.9,.25,1);
      font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;color:#eaf6ff; -webkit-font-smoothing:antialiased;background:transparent}
    /* the background is now a container so the NUI can open/close without a full page backdrop */
    .bg-container{
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:28px;
      /* previous full-page background moved here */
      background:
        radial-gradient(1200px 600px at 10% 10%, rgba(43,123,233,0.06), transparent),
        linear-gradient(180deg,var(--bg-0), #021024 95%);
      /* hide until lua opens it */
      opacity:0;
      transform:translateY(6px);
      transition:opacity 420ms ease, transform 420ms ease;
      pointer-events:none; /* prevents accidental interaction while closed */
    }
    .bg-container.azfw-appeared{
      opacity:1;
      transform:none;
      pointer-events:auto;
    }

    .app{width:100%;max-width:1200px;display:grid;grid-template-columns: minmax(320px,420px) 1fr;gap:28px;align-items:start}

    .panel{background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.02));border-radius:var(--radius);border:1px solid rgba(255,255,255,0.03);padding:18px;box-shadow: 0 12px 48px rgba(3,8,18,0.6);}
    .panel.animated{animation:panel-in 480ms var(--transition) both}
    @keyframes panel-in{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:none}}

    /* LEFT */
    .left{min-height:540px;display:flex;flex-direction:column;gap:12px;position:relative}
    .header{display:flex;align-items:center;gap:12px;width:100%;min-width:0}
    .logo{width:56px;height:56px;border-radius:50%;background:linear-gradient(135deg,var(--accent),var(--accent-2));display:flex;align-items:center;justify-content:center;font-weight:800;color:white;font-size:18px;flex:0 0 56px}
    .brand-text{display:flex;flex-direction:column;min-width:0;overflow:hidden}
    .brand-text h1{margin:0;font-size:18px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .brand-text p{margin:0;color:var(--muted);font-size:13px}

    .header-right{margin-left:auto;display:flex;gap:10px;align-items:center;min-width:0;flex:0 0 auto}
    .search{flex:1 1 160px;min-width:100px;max-width:280px;padding:10px 12px;border-radius:10px;border:1px solid rgba(255,255,255,0.03);background:transparent;color:inherit}
    .btn-ghost{flex:0 0 auto;background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--muted);padding:8px 12px;border-radius:8px;cursor:pointer}

    .cards-wrap{background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.00));border-radius:12px;padding:12px;border:1px solid rgba(255,255,255,0.02);display:flex;flex-direction:column;height:100%}
    .card-list{display:flex;flex-direction:column;gap:12px;overflow-y:auto;padding:6px}
    .card-list::-webkit-scrollbar{width:10px}
    .card-list::-webkit-scrollbar-thumb{background:rgba(0,0,0,0.2);border-radius:999px}

    .card{display:flex;align-items:center;gap:12px;padding:12px;border-radius:12px;background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.00));border:1px solid rgba(255,255,255,0.03);cursor:pointer;transition:transform var(--transition),box-shadow var(--transition),background 220ms;min-height:76px}
    .card:hover{transform:translateY(-4px);box-shadow:0 14px 40px rgba(3,8,18,0.45);background:linear-gradient(180deg, rgba(255,255,255,0.015), rgba(255,255,255,0.005))}
    .card.selected{outline:2px solid rgba(46,160,255,0.14);box-shadow:0 22px 60px rgba(43,123,233,0.10)}
    .card.entrance{animation:card-pop 360ms cubic-bezier(.2,.9,.25,1) both}
    @keyframes card-pop{from{opacity:0;transform:translateY(8px) scale(.99)}to{opacity:1;transform:none}}

    .avatar{width:44px;height:44px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700;color:var(--accent);background:linear-gradient(135deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01));border:1px solid rgba(255,255,255,0.03);font-size:16px}
    .meta h3{margin:0;font-size:15px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .meta p{margin:6px 0 0 0;color:var(--muted);font-size:13px}

    .card-right{margin-left:auto;display:flex;flex-direction:column;gap:6px;align-items:flex-end}
    .stat-pill{background:rgba(255,255,255,0.01);padding:6px 10px;border-radius:8px;color:var(--muted);font-size:13px}

    .create-large{margin-top:8px;padding:12px;border-radius:28px;background:linear-gradient(90deg,var(--accent),var(--accent-2));color:#fff;font-weight:700;border:none;cursor:pointer;box-shadow:0 16px 40px rgba(43,123,233,0.22);width:100%;transition:transform var(--transition);}
    .create-large:hover{transform:translateY(-3px)}

    /* CENTER */
    .preview-panel{min-height:540px;display:flex;flex-direction:column;gap:18px}
    .viewport{height:420px;border-radius:12px;background:linear-gradient(180deg,#072033,#041225);display:flex;align-items:center;justify-content:center;border:1px solid rgba(255,255,255,0.03);overflow:hidden}
    .big-avatar{width:100%;height:100%;display:flex;align-items:center;justify-content:center;font-size:clamp(64px,14vw,160px);font-weight:900;color:var(--accent);transition:transform 420ms cubic-bezier(.2,.9,.25,1)}
    .big-avatar.float{animation:floaty 4s ease-in-out infinite}
    @keyframes floaty{0%{transform:translateY(0)}50%{transform:translateY(-6px)}100%{transform:translateY(0)}}

    .info-row{display:flex;gap:18px;align-items:flex-start}
    .meta-side{flex:1;display:flex;flex-direction:column;gap:12px}
    .player-name{font-weight:800;font-size:20px}
    .player-sub{color:var(--muted)}
    .pills{display:flex;gap:8px}
    .pill{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.02);display:flex;justify-content:space-between;align-items:center;min-width:96px}
    .actions{display:flex;gap:8px}
    .btn-primary{background:linear-gradient(90deg,var(--accent),var(--accent-2));color:white;font-weight:700;padding:10px 14px;border-radius:8px;border:none;cursor:pointer}

    .card:focus{outline:2px dashed rgba(46,160,255,0.12);outline-offset:3px}
    button:focus{outline:2px solid rgba(46,160,255,0.16);outline-offset:3px}

    pre#detailBox{background:rgba(255,255,255,0.01);padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.02);min-height:140px;color:var(--muted);white-space:pre-wrap}

    @media (max-width:980px){
      .app{grid-template-columns:1fr;}
      .left{order:2}
      .preview-panel{order:1}
      .viewport{height:320px}
      .left{min-height:320px}
    }

    .muted{color:var(--muted)}


    /* ---------- Modal (in-UI) ---------- */
    .azfw-modal-backdrop{
      position:fixed; inset:0; display:none; align-items:center; justify-content:center; z-index:1200;
      background: linear-gradient(180deg, rgba(2,6,12,0.6), rgba(2,6,12,0.55));
      pointer-events:none;
    }
    .azfw-modal-backdrop.visible{display:flex; pointer-events:auto;}
    .azfw-modal{
      width:100%; max-width:640px; border-radius:12px; padding:18px; background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.02));
      border:1px solid rgba(255,255,255,0.04); box-shadow:0 30px 80px rgba(2,6,16,0.6);
      transform:translateY(6px); transition:transform 220ms ease, opacity 220ms ease;
    }
    .azfw-modal h3{margin:0 0 8px 0}
    .azfw-modal .row{display:flex;gap:8px;margin-bottom:10px}
    .azfw-modal label{font-size:13px;color:var(--muted);display:block;margin-bottom:6px}
    .azfw-modal input[type="text"], .azfw-modal input[type="number"], .azfw-modal select{
      width:100%; padding:10px 12px; border-radius:8px; border:1px solid rgba(255,255,255,0.03); background:transparent; color:inherit;
    }
    .azfw-modal .controls{display:flex;gap:8px;justify-content:flex-end;margin-top:8px}
    .azfw-modal .btn-cancel{background:transparent;border:1px solid rgba(255,255,255,0.04);padding:8px 12px;border-radius:8px;color:var(--muted); cursor:pointer}
    .azfw-modal .btn-confirm{background:linear-gradient(90deg,var(--accent),var(--accent-2)); color:white; padding:8px 12px;border-radius:8px;border:none; cursor:pointer}
    .azfw-modal p.help{color:var(--muted);font-size:13px;margin:8px 0 0 0}

    /* small responsive tweaks */
    @media (max-width:520px){
      .azfw-modal{margin:12px;}
      .row{flex-direction:column;}
    }
  </style>
</head>
<body>
  <!-- bg-container is the only element that carries the visual background.
       The NUI open/close will toggle the .azfw-appeared class on this container. -->
  <div class="bg-container" id="azfw-bg">
    <div class="app">

      <!-- LEFT -->
      <aside class="panel left animated" aria-label="Character selection">
        <div class="header">
          <div class="logo" aria-hidden="true">AZ</div>
          <div class="brand-text">
            <h1>Azure Framework</h1>
            <div class="muted">All characters — choose or create</div>
          </div>

          <div class="header-right">
            <input id="azfw-search" class="search" placeholder="Search characters..." aria-label="Search characters">
            <button id="azfw-sort" class="btn-ghost" title="Sort">Sort</button>
          </div>
        </div>

        <div class="cards-wrap">
          <div class="card-list" id="charGrid" aria-live="polite"></div>

          <div style="display:flex;justify-content:space-between;align-items:center;margin-top:6px">
            <small class="muted">Press Enter to confirm selection</small>
            <small class="muted">redone</small>
          </div>

        </div>

        <button id="azfw-create" class="create-large">+  Create Character</button>
      </aside>

      <!-- CENTER -->
      <section class="panel preview-panel animated" aria-label="Preview">
        <div class="viewport">
          <div id="azfw-preview" class="big-avatar float">A</div>
        </div>

        <div class="info-row">
          <div class="meta-side">
            <div>
              <div id="azfw-metaName" class="player-name">No character selected</div>
              <div id="azfw-metaDesc" class="player-sub">Select a character on the left or create one.</div>
            </div>

            <div class="pills">
              <div class="pill">Health <strong id="azfw-health">—</strong></div>
              <div class="pill">Armor <strong id="azfw-armor">—</strong></div>
              <div class="pill">Cash <strong id="azfw-cash">—</strong></div>
            </div>

            <div class="actions">
              <button id="azfw-start" class="btn-primary">Start</button>
              <button id="azfw-edit" class="btn-ghost">Edit</button>
              <button id="azfw-delete" class="btn-ghost">Delete</button>
            </div>
          </div>
        </div>

        <div>
          <h4 style="margin:0 0 6px 0">Character Details</h4>
          <pre id="azfw-detailBox">No selection — click a character to view more</pre>
        </div>
      </section>

    </div>
  </div>

  <!-- In-UI modal (single shared for create/edit/delete) -->
  <div id="azfw-modal-backdrop" class="azfw-modal-backdrop" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="azfw-modal" id="azfw-modal" role="document" aria-labelledby="azfw-modal-title">
      <!-- content filled by JS -->
      <div id="azfw-modal-content"></div>
    </div>
  </div>

  <script>
    (function(){
      // RESOURCE is set dynamically by the client when UI opens
      let RESOURCE = null;

      const bg = document.getElementById('azfw-bg');

      window.addEventListener('message', (ev) => {
        const d = ev.data || {};
        if (!d.type) return;

        if (d.type === 'azfw_set_resource') {
          RESOURCE = d.resource || RESOURCE;
          console.log('azfw NUI: resource set to', RESOURCE);
          return;
        }

        if (d.type === 'azfw_open_ui') {
          showUI();
          if (Array.isArray(d.chars)) loadCharacters(d.chars);
        } else if (d.type === 'azfw_update_chars') {
          if (Array.isArray(d.chars)) loadCharacters(d.chars);
        } else if (d.type === 'azfw_close_ui') {
          hideUI();
        }
      });

      function postToLua(endpoint, payload = {}) {
        if (!RESOURCE) {
          console.warn('azfw NUI: RESOURCE not set yet; fetch will fail. endpoint=', endpoint, 'payload=', payload);
          return Promise.resolve(null);
        }
        return fetch(`https://${RESOURCE}/${endpoint}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json; charset=UTF-8' },
          body: JSON.stringify(payload)
        }).then(r => {
          return r.text().then(text => {
            try { return text ? JSON.parse(text) : null; } catch (e) { return text || null; }
          });
        }).catch(e => { console.error('NUI->Lua fetch error', e); return null; });
      }

      const $ = sel => document.querySelector(sel);
      const get = id => document.getElementById(id);

      const gridId = 'charGrid';
      const preview = get('azfw-preview');
      const nameEl = get('azfw-metaName');
      const descEl = get('azfw-metaDesc');
      const healthEl = get('azfw-health');
      const armorEl = get('azfw-armor');
      const cashEl = get('azfw-cash');
      const detailEl = get('azfw-detailBox');

      // modal elements
      const modalBackdrop = get('azfw-modal-backdrop');
      const modalContent = get('azfw-modal-content');

      let state = { characters: [], selectedId: null };

      function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[c])); }

      function showUI(){
        bg.classList.add('azfw-appeared');
        setTimeout(()=> {
          const s = get('azfw-search');
          if (s) s.focus();
        }, 60);
      }
      function hideUI(){
        closeModal();
        bg.classList.remove('azfw-appeared');
      }

      function loadCharacters(chars){
        state.characters = Array.isArray(chars) ? chars.slice() : [];
        state.selectedId = state.selectedId && state.characters.find(c => c.charid === state.selectedId) ? state.selectedId : (state.characters[0] ? state.characters[0].charid : null);
        renderGrid();
        if (state.selectedId) selectCharacter(state.selectedId, {silent:true});
      }

      function renderGrid(filter=''){
        const grid = get(gridId);
        if (!grid) { console.warn('charGrid element missing'); return; }
        grid.innerHTML = '';
        const chars = state.characters.filter(c => (c.name || '').toLowerCase().includes(String(filter).toLowerCase()));
        if (!chars.length) {
          const empty = document.createElement('div');
          empty.className = 'card';
          empty.innerHTML = '<div style="padding:20px;color:var(--muted)">No characters</div>';
          grid.appendChild(empty);
          return;
        }
        chars.forEach((c, i) => {
          const el = document.createElement('div');
          el.className = 'card' + (state.selectedId === c.charid ? ' selected' : '');
          el.tabIndex = 0;
          const avatarLetter = (c.name || '?').charAt(0).toUpperCase();

          const cashHtml = (c.cash !== null && c.cash !== undefined) ? ('$' + escapeHtml(String(c.cash))) : '—';

          el.innerHTML = `
            <div class="avatar">${escapeHtml(avatarLetter)}</div>
            <div class="meta">
              <h3>${escapeHtml(c.name || 'Unknown')}</h3>
              <p>${escapeHtml(c.gender || '')} ${c.age ? ' • ' + escapeHtml(String(c.age)) + ' years' : ''}</p>
            </div>
            <div class="card-right">
              <div class="stat-pill">HP ${escapeHtml(String(c.health != null ? c.health : '—'))}</div>
              <div class="stat-pill">${cashHtml}</div>
            </div>
          `;
          // CLICK selects only (does NOT enter)
          el.addEventListener('click', () => {
            selectCharacter(c.charid);
          });
          el.addEventListener('keydown', e => { if (e.key === 'Enter') { e.preventDefault(); selectCharacter(c.charid); } });
          setTimeout(()=> el.classList.add('entrance'), 25 * i);
          grid.appendChild(el);
        });
      }

      function selectCharacter(charid, opts = {}) {
        const c = state.characters.find(x => x.charid === charid);
        if (!c) return;
        state.selectedId = charid;
        preview.textContent = (c.name || '?').charAt(0).toUpperCase();
        nameEl.textContent = c.name || 'Unknown';
        descEl.textContent = (c.gender || '') + (c.age ? ' • ' + c.age + ' years' : '');
        healthEl.textContent = c.health != null ? c.health : '—';
        armorEl.textContent = c.armor != null ? c.armor : '—';
        cashEl.textContent = c.cash != null ? ('$' + c.cash) : '—';
        detailEl.textContent = `ID: ${c.charid}\nName: ${c.name}\nGender: ${c.gender || '-'}\nAge: ${c.age || '-'}\nHealth: ${c.health || '-'}\nArmor: ${c.armor || '-'}\nCash: ${c.cash != null ? '$' + c.cash : '-'}`;
        renderGrid(get('azfw-search').value || '');
        preview.style.transform = 'scale(0.96)';
        setTimeout(()=> preview.style.transform = '', 120);
      }

      // ---------- Modal helpers ----------
      let modalState = { mode: null, charId: null };

      function openModalCreate() {
        modalState.mode = 'create';
        modalState.charId = null;
        modalContent.innerHTML = `
          <h3 id="azfw-modal-title">Create Character</h3>
          <div class="row">
            <div style="flex:1">
              <label>First name</label>
              <input id="m-first" type="text" value="New" />
            </div>
            <div style="width:160px">
              <label>Age</label>
              <input id="m-age" type="number" min="0" max="120" value="" />
            </div>
          </div>
          <div class="row">
            <div style="flex:1">
              <label>Last name</label>
              <input id="m-last" type="text" value="Citizen" />
            </div>
            <div style="width:160px">
              <label>Gender</label>
              <select id="m-gender">
                <option value="">-</option>
                <option value="Male">Male</option>
                <option value="Female">Female</option>
                <option value="Other">Other</option>
              </select>
            </div>
          </div>
          <p class="help">Fill out the details and press Create. This will send the request to the server.</p>
          <div class="controls">
            <button class="btn-cancel" id="m-cancel">Cancel</button>
            <button class="btn-confirm" id="m-confirm">Create</button>
          </div>
        `;
        showModal();
        requestAnimationFrame(()=> get('m-first').focus());
        // handlers
        get('m-cancel').onclick = closeModal;
        get('m-confirm').onclick = async () => {
          const first = (get('m-first').value || '').trim();
          const last = (get('m-last').value || '').trim();
          const gender = (get('m-gender').value || '').trim();
          const ageRaw = get('m-age').value;
          const age = ageRaw !== '' ? parseInt(ageRaw) : null;
          if (!first) { get('m-first').focus(); return; }
          // optimistic local update: generate temp id to show instantly
          const tempId = 'temp_' + Date.now();
          const newChar = {
            charid: tempId,
            firstname: first,
            lastname: last,
            name: `${first} ${last}`,
            gender: gender,
            age: age,
            health: 100,
            armor: 0,
            cash: 0
          };
          state.characters.push(newChar);
          loadCharacters(state.characters);
          selectCharacter(tempId);
          closeModal();
          // send to lua (server should respond with real list or item via azfw_update_chars)
          const resp = await postToLua('azfw_create_character', { first, last, gender, age });
          // if server responds with updated chars, replace; else if returns real char id, update temp
          if (resp && Array.isArray(resp.chars)) {
            loadCharacters(resp.chars);
          } else if (resp && resp.charid) {
            // replace temp item
            const idx = state.characters.findIndex(c=>c.charid===tempId);
            if (idx !== -1) {
              state.characters[idx].charid = resp.charid;
              if (resp.name) state.characters[idx].name = resp.name;
              loadCharacters(state.characters);
            }
          } else {
            // nothing — server didn't return data. You can rely on your normal azfw_update_chars message from the server instead.
            console.log('azfw_create_character: server returned', resp);
          }
        };
      }

      function openModalEdit(charid) {
        const c = state.characters.find(x => x.charid === charid);
        if (!c) return;
        modalState.mode = 'edit';
        modalState.charId = charid;
        const first = c.firstname || (c.name ? c.name.split(' ')[0] : '');
        const last = c.lastname || (c.name ? c.name.split(' ').slice(1).join(' ') : '');
        const age = (c.age != null && c.age !== '-') ? c.age : '';
        const gender = c.gender || '';
        modalContent.innerHTML = `
          <h3 id="azfw-modal-title">Edit Character — ${escapeHtml(c.name||'')}</h3>
          <div class="row">
            <div style="flex:1">
              <label>First name</label>
              <input id="m-first" type="text" value="${escapeHtml(first)}" />
            </div>
            <div style="width:160px">
              <label>Age</label>
              <input id="m-age" type="number" min="0" max="120" value="${escapeHtml(age)}" />
            </div>
          </div>
          <div class="row">
            <div style="flex:1">
              <label>Last name</label>
              <input id="m-last" type="text" value="${escapeHtml(last)}" />
            </div>
            <div style="width:160px">
              <label>Gender</label>
              <select id="m-gender">
                <option value="">-</option>
                <option value="Male">Male</option>
                <option value="Female">Female</option>
                <option value="Other">Other</option>
              </select>
            </div>
          </div>
          <p class="help">Edit the fields and press Save to update the character.</p>
          <div class="controls">
            <button class="btn-cancel" id="m-cancel">Cancel</button>
            <button class="btn-confirm" id="m-confirm">Save</button>
          </div>
        `;
        showModal();
        // set gender select value after insertion (avoids escaping / quoting issues)
        get('m-gender').value = gender;
        requestAnimationFrame(()=> get('m-first').focus());
        get('m-cancel').onclick = closeModal;
        get('m-confirm').onclick = async () => {
          const firstVal = (get('m-first').value || '').trim();
          const lastVal = (get('m-last').value || '').trim();
          const genderVal = (get('m-gender').value || '').trim();
          const ageRaw = get('m-age').value;
          const ageVal = ageRaw !== '' ? parseInt(ageRaw) : null;
          if (!firstVal) { get('m-first').focus(); return; }
          // update local object immediately for snappy UI
          const idx = state.characters.findIndex(x=>x.charid===charid);
          if (idx !== -1) {
            state.characters[idx].firstname = firstVal;
            state.characters[idx].lastname = lastVal;
            state.characters[idx].name = `${firstVal} ${lastVal}`.trim();
            state.characters[idx].gender = genderVal;
            state.characters[idx].age = ageVal;
            loadCharacters(state.characters);
            selectCharacter(charid);
          }
          closeModal();
          // send edit to server (your original endpoint used azfw_create_character with editCharId)
          const resp = await postToLua('azfw_create_character', { first: firstVal, last: lastVal, editCharId: charid, gender: genderVal, age: ageVal });
          if (resp && Array.isArray(resp.chars)) {
            loadCharacters(resp.chars);
          } else {
            console.log('azfw_edit response', resp);
          }
        };
      }

      function openModalDelete(charid) {
        const c = state.characters.find(x => x.charid === charid);
        if (!c) return;
        modalState.mode = 'delete';
        modalState.charId = charid;
        modalContent.innerHTML = `
          <h3 id="azfw-modal-title">Delete Character</h3>
          <p class="help">Are you sure you want to permanently delete <strong>${escapeHtml(c.name||'this character')}</strong>?</p>
          <div class="controls">
            <button class="btn-cancel" id="m-cancel">Cancel</button>
            <button class="btn-confirm" id="m-confirm">Delete</button>
          </div>
        `;
        showModal();
        get('m-cancel').onclick = closeModal;
        get('m-confirm').onclick = async () => {
          // optimistically remove from local state
          state.characters = state.characters.filter(x => x.charid !== charid);
          // reselect first available
          state.selectedId = state.characters[0] ? state.characters[0].charid : null;
          loadCharacters(state.characters);
          if (state.selectedId) selectCharacter(state.selectedId);
          else {
            preview.textContent = 'A';
            nameEl.textContent = 'No character selected';
            descEl.textContent = 'Select a character on the left or create one.';
            detailEl.textContent = 'No selection — click a character to view more';
          }
          closeModal();
          const resp = await postToLua('azfw_delete_character', { charid });
          if (resp && Array.isArray(resp.chars)) {
            loadCharacters(resp.chars);
          } else {
            console.log('azfw_delete_character response', resp);
          }
        };
      }

      function showModal() {
        modalBackdrop.classList.add('visible');
        modalBackdrop.setAttribute('aria-hidden', 'false');
        setTimeout(()=> {
          const modal = document.querySelector('.azfw-modal');
          if (modal) modal.style.transform = 'translateY(0)';
        }, 10);
      }
      function closeModal() {
        modalBackdrop.classList.remove('visible');
        modalBackdrop.setAttribute('aria-hidden', 'true');
        modalContent.innerHTML = '';
        modalState = { mode: null, charId: null };
        // return focus to search to keep the UI keyboard-friendly
        const s = get('azfw-search');
        if (s) s.focus();
      }

      // ---------- Wire up buttons (replace old prompts/confirms) ----------
      // Create
      get('azfw-create').addEventListener('click', () => {
        openModalCreate();
      });

      // Start: send selectedId to lua (this is the only action that "enters")
      get('azfw-start').addEventListener('click', () => {
        if (!state.selectedId) return; // silently ignore
        postToLua('azfw_select_character', { charid: state.selectedId }).then(()=> {});
      });

      // Edit
      get('azfw-edit').addEventListener('click', () => {
        if (!state.selectedId) return; // nothing selected
        openModalEdit(state.selectedId);
      });

      // Delete
      get('azfw-delete').addEventListener('click', () => {
        if (!state.selectedId) return;
        openModalDelete(state.selectedId);
      });

      get('azfw-search').addEventListener('input', (e) => renderGrid(e.target.value));
      get('azfw-sort').addEventListener('click', () => {
        state.characters.sort((a,b) => {
          const ai = parseInt(a.charid || '') || 0; const bi = parseInt(b.charid || '') || 0;
          if (ai && bi) return bi - ai;
          return (b.name||'').localeCompare(a.name||'');
        });
        renderGrid(get('azfw-search').value || '');
      });

      // keyboard: Enter starts, + opens create, Esc closes UI (and modal Esc closes modal)
      window.addEventListener('keydown', (e) => {
        // if modal open, handle modal-specific keys
        const modalOpen = modalBackdrop.classList.contains('visible');
        if (modalOpen) {
          if (e.key === 'Escape') {
            e.preventDefault();
            closeModal();
          }
          return; // don't process other global keys while modal open
        }

        if (e.key === 'Enter') {
          // don't start if focus is inside search/input or on a card (to allow selecting)
          const active = document.activeElement;
          const isInput = active && (active.tagName === 'INPUT' || active.tagName === 'TEXTAREA' || active.tagName === 'SELECT');
          const inCard = active && typeof active.closest === 'function' && active.closest('.card');
          if (!isInput && !inCard) {
            if (state.selectedId) postToLua('azfw_select_character', { charid: state.selectedId });
          }
        } else if (e.key === '+') {
          get('azfw-create').click();
        } else if (e.key === 'Escape') {
          postToLua('azfw_close_ui', {}).then(()=> hideUI());
        }
      });

      // expose a small API for client.lua to call directly with SendNUIMessage
      window.azfw = {
        load: loadCharacters,
        hide: hideUI,
        show: showUI,
        // helpers for external code if needed
        openEdit: (charid) => openModalEdit(charid),
        openDelete: (charid) => openModalDelete(charid)
      };

      // show bg-container now (client controls actual open)
      requestAnimationFrame(()=> bg.classList.add('azfw-appeared'));
    })();
  </script>
</body>
</html>

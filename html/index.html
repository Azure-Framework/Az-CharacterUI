<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Azure Framework â€” Character Select (NUI)</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg-0:#041027; --bg-1:#051226;
      --muted:#97b8d9; --accent:#d52eff; --accent-2:#2b7be9;
      --radius:14px; --transition:200ms cubic-bezier(.2,.9,.25,1);
      font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
      --max-ui-width:1200px;
    }
    html,body{height:100%;margin:0;color:#eaf6ff;background:transparent;overflow:hidden;-webkit-font-smoothing:antialiased}
    *{box-sizing:border-box}
    .bg-container{height:100vh;width:100%;display:flex;align-items:center;justify-content:center;padding:20px;background:radial-gradient(1200px 600px at 10% 10%, rgba(43,123,233,0.06), transparent),linear-gradient(180deg,var(--bg-0), var(--bg-1) 95%);opacity:0;transform:translateY(6px);transition:opacity 340ms ease, transform 340ms ease;pointer-events:none;}
    .bg-container.azfw-appeared{opacity:1;transform:none;pointer-events:auto;}
    .app{width:100%;max-width:var(--max-ui-width);display:grid;grid-template-columns: minmax(300px,420px) 1fr;gap:20px;align-items:start;height:calc(100vh - 40px);max-height:100%;}
    .panel{background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.02));border-radius:var(--radius);border:1px solid rgba(255,255,255,0.03);padding:16px;box-shadow: 0 12px 48px rgba(3,8,18,0.6);display:flex;flex-direction:column;min-height:0;}
    .panel.animated{animation:panel-in 420ms var(--transition) both}
    @keyframes panel-in{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:none}}
    .left{display:flex;flex-direction:column;gap:12px;min-height:0;}
    .header{display:flex;align-items:center;gap:12px;width:100%;min-width:0;flex-wrap:wrap;}
    .logo{width:56px;height:56px;border-radius:50%;background:linear-gradient(135deg,var(--accent),var(--accent-2));display:flex;align-items:center;justify-content:center;font-weight:800;color:white;font-size:18px;flex:0 0 56px;min-width:56px;}
    .brand-text{display:flex;flex-direction:column;min-width:0;flex: 1 1 220px;margin-right:8px;}
    .brand-text h1{margin:0;font-size:18px;line-height:1.05;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;padding-right:6px;}
    .brand-text p{margin:0;color:var(--muted);font-size:13px;}
    .header-right{display:flex;gap:10px;align-items:center;flex:0 0 auto;margin-left:auto}
    .search{flex:0 1 180px;min-width:80px;max-width:260px;padding:10px 12px;border-radius:10px;border:1px solid rgba(255,255,255,0.03);background:transparent;color:inherit}
    .btn-ghost{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--muted);padding:8px 12px;border-radius:8px;cursor:pointer}
    .cards-wrap{background: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.00));border-radius:12px;padding:10px;border:1px solid rgba(255,255,255,0.02);display:flex;flex-direction:column;flex:1 1 auto;min-height:0;}
    .card-list{display:flex;flex-direction:column;gap:10px;overflow:auto;padding:6px;min-height:0;flex:1 1 auto;}
    .card{display:flex;align-items:center;gap:12px;padding:10px;border-radius:12px;background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.00));border:1px solid rgba(255,255,255,0.03);cursor:pointer;transition:transform var(--transition),box-shadow var(--transition),background 220ms;min-height:68px}
    .card:hover{transform:translateY(-4px);box-shadow:0 14px 40px rgba(3,8,18,0.45);}
    .card.selected{outline:2px solid rgba(46,160,255,0.14);box-shadow:0 22px 60px rgba(43,123,233,0.10)}
    .avatar{width:44px;height:44px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700;color:var(--accent);background:linear-gradient(135deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01));border:1px solid rgba(255,255,255,0.03);font-size:16px;flex:0 0 44px}
    .meta{min-width:0;flex:1 1 auto}
    .meta h3{margin:0;font-size:15px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .meta p{margin:6px 0 0 0;color:var(--muted);font-size:13px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .card-right{margin-left:auto;display:flex;flex-direction:column;gap:6px;align-items:flex-end}
    .stat-pill{background:rgba(255,255,255,0.01);padding:6px 10px;border-radius:8px;color:var(--muted);font-size:13px}
    .create-large{margin-top:8px;padding:12px;border-radius:28px;background:linear-gradient(90deg,var(--accent),var(--accent-2));color:#fff;font-weight:700;border:none;cursor:pointer;box-shadow:0 16px 40px rgba(43,123,233,0.18);width:100%;transition:transform var(--transition);}
    .create-large:hover{transform:translateY(-3px)}
    .preview-panel{display:flex;flex-direction:column;gap:14px;flex:1 1 auto;min-height:0}
    .viewport{flex:0 0 auto;height:40vh;min-height:160px;max-height:420px;border-radius:12px;background:linear-gradient(180deg,#072033,#041225);display:flex;align-items:center;justify-content:center;border:1px solid rgba(255,255,255,0.03);overflow:hidden}
    .big-avatar{width:100%;height:100%;display:flex;align-items:center;justify-content:center;font-size:clamp(56px,12vw,140px);font-weight:900;color:var(--accent);transition:transform 420ms cubic-bezier(.2,.9,.25,1)}
    .big-avatar.float{animation:floaty 4s ease-in-out infinite}
    @keyframes floaty{0%{transform:translateY(0)}50%{transform:translateY(-6px)}100%{transform:translateY(0)}}
    .info-row{display:flex;gap:16px;align-items:flex-start}
    .meta-side{flex:1;display:flex;flex-direction:column;gap:12px}
    .player-name{font-weight:800;font-size:20px;line-height:1}
    .player-sub{color:var(--muted)}
    .pills{display:flex;gap:8px;flex-wrap:wrap}
    .pill{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.02);display:flex;justify-content:space-between;align-items:center;min-width:96px}
    .actions{display:flex;gap:8px;flex-wrap:wrap}
    .btn-primary{background:linear-gradient(90deg,var(--accent),var(--accent-2));color:white;font-weight:700;padding:10px 14px;border-radius:8px;border:none;cursor:pointer}
    pre#azfw-detailBox{background:rgba(255,255,255,0.01);padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.02);min-height:140px;color:var(--muted);white-space:pre-wrap;overflow:auto;max-height:22vh}

    .modal-backdrop{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;z-index:3000;opacity:0;pointer-events:none;transition:opacity 180ms ease;backdrop-filter:blur(6px);background:rgba(10,20,40,0.8);}
    .modal-backdrop.visible{opacity:1;pointer-events:auto;}
    .modal{width:100%;max-width:520px;background:linear-gradient(180deg,rgba(15,25,50,0.95),rgba(5,10,20,0.95));border-radius:var(--radius);padding:16px;border:1px solid rgba(50,100,200,0.25);box-shadow:0 18px 60px rgba(0,0,0,0.85)}
    .modal h3{margin:0 0 8px 0;color:#4da6ff}
    .modal .hint{color:var(--muted);font-size:13px}
    .modal .row input{display:inline-block;margin-right:8px;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.03);background:transparent;color:inherit}
    .modal .buttons{display:flex;gap:8px;justify-content:flex-end;margin-top:12px}
    .btn{padding:8px 10px;border-radius:8px;border:1px solid rgba(255,255,255,0.03);background:transparent;color:var(--muted);cursor:pointer}
    .btn-save{background:linear-gradient(90deg,var(--accent),var(--accent-2));color:#fff;border:none}
    .btn-cancel{background:transparent}
    .toast-wrap{position:fixed;right:18px;bottom:18px;z-index:99999;display:flex;flex-direction:column;gap:8px;align-items:flex-end;pointer-events:auto;}
    .toast{background:rgba(0,0,0,0.6);padding:10px 14px;border-radius:10px;color:#eaf6ff;border:1px solid rgba(255,255,255,0.03);box-shadow:0 6px 24px rgba(3,8,18,0.5)}
    ::-webkit-scrollbar{width:0;height:0}
    *{-ms-overflow-style:none;scrollbar-width:none;}

    .spawn-modal-backdrop{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(2,8,18,0.6);z-index:1500;backdrop-filter: blur(4px);}
    .spawn-modal-backdrop.open{display:flex;}
    .spawn-modal{width:100%;max-width:1100px;height:80vh;background:linear-gradient(180deg,#041225,#03101a);border-radius:12px;padding:14px;border:1px solid rgba(255,255,255,0.03);box-shadow:0 30px 90px rgba(0,0,0,0.7);display:flex;gap:12px;color:#eaf6ff;overflow:hidden;}
    .spawn-left{flex:1 1 0;display:flex;flex-direction:column;gap:8px;min-width:0;}
    .spawn-map{flex:1 1 auto;border-radius:10px;overflow:hidden;position:relative;background:linear-gradient(180deg,#0b2230,#03101a);border:1px solid rgba(255,255,255,0.03);cursor:grab;user-select:none;}
    .spawn-map:active{cursor:grabbing;}
    .spawn-map .map-viewport{position:absolute;inset:0;overflow:hidden;}
    .map-content{position:relative;transform-origin:0 0;will-change:transform;}
    .map-content img{display:block;width:100%;height:100%;object-fit:cover;user-drag:none;user-select:none;-webkit-user-drag:none;}
    .spawn-pin{position:absolute;width:44px;height:56px;transform:translate(-50%,-100%);cursor:pointer;z-index:60;display:flex;align-items:flex-end;justify-content:center;transition:transform 120ms ease,opacity 120ms ease;pointer-events:auto;padding:4px;margin-top:-4px;}
    .spawn-pin .dot{width:28px;height:28px;border-radius:50%;background:#e74c3c;border:3px solid #ffffff;box-shadow:0 6px 18px rgba(0,0,0,0.5);margin-bottom:6px;pointer-events:none;}
    .spawn-pin.active .dot{background:var(--accent);box-shadow:0 0 0 10px rgba(46,160,255,0.08),0 8px 22px rgba(0,0,0,0.55);}
    .spawn-pin:hover{transform:translate(-50%,-100%) scale(1.06);}
    .spawn-right{width:320px;min-width:220px;display:flex;flex-direction:column;gap:8px;}
    .spawn-list{background:rgba(255,255,255,0.02);border-radius:8px;padding:8px;overflow:auto;flex:0 0 320px;max-height:60vh;}
    .spawn-list .item{padding:8px;border-radius:6px;cursor:pointer;}
    .spawn-list .item.selected{background:rgba(46,160,255,0.06);border-left:3px solid var(--accent-2);padding-left:6px;}
    .spawn-controls{display:flex;gap:8px;flex-wrap:wrap;}
    .spawn-editor{display:none;flex-direction:column;gap:6px;}
    .spawn-editor.open{display:flex;}
    .spawn-editor input[type="text"],.spawn-editor input[type="number"]{width:100%;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.03);background:transparent;color:inherit;}
    .zoom-controls{position:absolute;left:8px;top:8px;display:flex;flex-direction:column;gap:8px;z-index:200;}
    .zoom-btn{background:rgba(0,0,0,0.4);border:1px solid rgba(255,255,255,0.04);padding:6px 8px;border-radius:8px;cursor:pointer;color:var(--muted);}
    .zoom-btn:hover{background:rgba(255,255,255,0.02);color:var(--accent);}
    .btn-ghost[disabled], .btn[disabled]{opacity:.45;cursor:not-allowed;}
  </style>
</head>
<body>
  <div class="bg-container" id="azfw-bg">
    <div class="app">
      <aside class="panel left animated">
        <div class="header">
          <div id="ui-logo" class="logo">AZ</div>
          <div class="brand-text">
            <h1 id="ui-brandTitle">Azure Framework</h1>
            <div id="ui-brandSubtitle" class="muted">All characters â€” choose or create</div>
          </div>
          <div class="header-right">
            <input id="azfw-search" class="search" placeholder="Search characters...">
            <button id="azfw-sort" class="btn-ghost">Sort</button>
          </div>
        </div>
        <div class="cards-wrap">
          <div class="card-list" id="charGrid"></div>
          <div style="display:flex;justify-content:space-between;align-items:center;margin-top:6px">
            <small class="muted">Press Enter to confirm selection</small>
            <small class="muted">redone</small>
          </div>
        </div>
        <button id="azfw-create" class="create-large">+ Create Character</button>
      </aside>

      <section class="panel preview-panel animated">
        <div class="viewport">
          <div id="azfw-preview" class="big-avatar float">A</div>
        </div>
        <div class="info-row">
          <div class="meta-side">
            <div>
              <div id="azfw-metaName" class="player-name">No character selected</div>
              <div id="azfw-metaDesc" class="player-sub">Select a character on the left or create one.</div>
            </div>
            <div class="pills">
              <div class="pill">Health <strong id="azfw-health">â€”</strong></div>
              <div class="pill">Armor <strong id="azfw-armor">â€”</strong></div>
              <div class="pill">Cash <strong id="azfw-cash">â€”</strong></div>
            </div>
            <div class="actions">
              <button id="azfw-start" class="btn-primary">Start</button>
              <button id="azfw-edit" class="btn-ghost">Edit</button>
              <button id="azfw-delete" class="btn-ghost">Delete</button>
              <button id="azfw-open-spawn" class="btn-ghost">Spawn</button>
            </div>
          </div>
        </div>
        <div style="flex:1 1 auto;min-height:0">
          <h4 style="margin:0 0 6px 0">Character Details</h4>
          <pre id="azfw-detailBox">No selection â€” click a character to view more</pre>
        </div>
      </section>
    </div>
  </div>

  <!-- Create Modal -->
  <div id="modal-create" class="modal-backdrop" aria-hidden="true" tabindex="-1">
    <div class="modal">
      <h3 id="modal-create-title">Create Character</h3>
      <div class="hint">Fill out the name fields and save.</div>
      <div class="row" style="margin-top:12px">
        <input id="modal-first" type="text" placeholder="First name" autocomplete="off">
        <input id="modal-last" type="text" placeholder="Last name" autocomplete="off">
      </div>
      <div class="buttons">
        <button id="modal-create-cancel" class="btn btn-cancel">Cancel</button>
        <button id="modal-create-save" class="btn btn-save">Save</button>
      </div>
    </div>
  </div>

  <!-- Delete Modal -->
  <div id="modal-delete" class="modal-backdrop" aria-hidden="true" tabindex="-1">
    <div class="modal">
      <h3 id="modal-delete-title">Delete character</h3>
      <div class="delete-msg" id="modal-delete-msg">Are you sure?</div>
      <div class="buttons">
        <button id="modal-delete-cancel" class="btn btn-cancel">Cancel</button>
        <button id="modal-delete-confirm" class="btn btn-save">Delete</button>
      </div>
    </div>
  </div>

  <!-- Confirm Modal -->
  <div id="modal-confirm" class="modal-backdrop" aria-hidden="true" tabindex="-1">
    <div class="modal">
      <h3 id="modal-confirm-title">Confirm</h3>
      <div id="modal-confirm-msg" style="margin:8px 0;color:var(--muted)"></div>
      <div class="buttons">
        <button id="modal-confirm-cancel" class="btn btn-cancel">Cancel</button>
        <button id="modal-confirm-confirm" class="btn btn-save">Confirm</button>
      </div>
    </div>
  </div>

  <div class="toast-wrap" id="toastWrap"></div>

  <script>
  (function(){
    let RESOURCE = null;
    const bg = document.getElementById('azfw-bg');

    window.addEventListener('message', (ev) => {
      const d = ev.data || {};
      if (!d.type) return;
      if (d.type === 'azfw_set_resource') { RESOURCE = d.resource || RESOURCE; return; }
      if (d.type === 'azfw_open_ui') { showUI(); if (Array.isArray(d.chars)) loadCharacters(d.chars); }
      else if (d.type === 'azfw_update_chars') { if (Array.isArray(d.chars)) loadCharacters(d.chars); }
      else if (d.type === 'azfw_close_ui') hideUI();
    });

    function postToLua(endpoint, payload = {}) {
      if (!RESOURCE) return Promise.resolve(null);
      return fetch(`https://${RESOURCE}/${endpoint}`, {
        method:'POST',
        headers:{'Content-Type':'application/json; charset=UTF-8'},
        body: JSON.stringify(payload)
      }).then(r=>r.text().then(t=>{ try{return t?JSON.parse(t):null;}catch(e){return t||null;} }))
        .catch(()=>null);
    }

    const get = id => document.getElementById(id);

    const preview = get('azfw-preview');
    const nameEl = get('azfw-metaName');
    const descEl = get('azfw-metaDesc');
    const healthEl = get('azfw-health');
    const armorEl = get('azfw-armor');
    const cashEl = get('azfw-cash');
    const detailEl = get('azfw-detailBox');

    const modalCreate = get('modal-create');
    const modalDelete = get('modal-delete');
    const modalFirst = get('modal-first');
    const modalLast = get('modal-last');
    const createSaveBtn = get('modal-create-save');
    const createCancelBtn = get('modal-create-cancel');
    const deleteConfirmBtn = get('modal-delete-confirm');
    const deleteCancelBtn = get('modal-delete-cancel');

    const toastWrap = get('toastWrap');

    let state = { characters: [], selectedId: null };
    let pendingEditId = null;
    let pendingDeleteId = null;

    function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[c])); }
    function showUI(){ bg.classList.add('azfw-appeared'); setTimeout(()=>{ const s=get('azfw-search'); if(s) s.focus(); },60); }
    function hideUI(){ bg.classList.remove('azfw-appeared'); }

    function loadCharacters(chars){
      state.characters = Array.isArray(chars) ? chars.slice() : [];
      state.selectedId = state.selectedId && state.characters.find(c=>c.charid===state.selectedId) ? state.selectedId : (state.characters[0]?state.characters[0].charid:null);
      renderGrid();
      if (state.selectedId) selectCharacter(state.selectedId, {silent:true});
    }

    function renderGrid(filter=''){
      const grid = get('charGrid');
      grid.innerHTML = '';
      const chars = state.characters.filter(c => (c.name||'').toLowerCase().includes(String(filter).toLowerCase()));
      if (!chars.length){
        const empty = document.createElement('div');
        empty.className='card';
        empty.innerHTML='<div style="padding:20px;color:var(--muted)">No characters</div>';
        grid.appendChild(empty);
        return;
      }
      chars.forEach((c) => {
        const el = document.createElement('div');
        el.className = 'card' + (state.selectedId===c.charid?' selected':'');
        el.tabIndex = 0;
        const avatarLetter = (c.name||'?').charAt(0).toUpperCase();
        const cashHtml = (c.cash!=null) ? ('$'+escapeHtml(String(c.cash))) : 'â€”';
        el.innerHTML = `
          <div class="avatar">${escapeHtml(avatarLetter)}</div>
          <div class="meta">
            <h3>${escapeHtml(c.name || 'Unknown')}</h3>
            <p>${escapeHtml(c.gender || '')} ${c.age ? ' â€¢ ' + escapeHtml(String(c.age)) + ' years' : ''}</p>
          </div>
          <div class="card-right">
            <div class="stat-pill">HP ${escapeHtml(String(c.health!=null?c.health:'â€”'))}</div>
            <div class="stat-pill">${cashHtml}</div>
          </div>`;
        el.addEventListener('click', ()=>selectCharacter(c.charid));
        el.addEventListener('keydown', e=>{ if(e.key==='Enter'){ e.preventDefault(); selectCharacter(c.charid);} });
        grid.appendChild(el);
      });
    }

    function selectCharacter(charid){
      const c = state.characters.find(x=>x.charid===charid);
      if(!c) return;
      state.selectedId = charid;
      preview.textContent = (c.name||'?').charAt(0).toUpperCase();
      nameEl.textContent = c.name || 'Unknown';
      descEl.textContent = (c.gender||'') + (c.age ? ' â€¢ ' + c.age + ' years' : '');
      healthEl.textContent = c.health!=null?c.health:'â€”';
      armorEl.textContent = c.armor!=null?c.armor:'â€”';
      cashEl.textContent = c.cash!=null?('$'+c.cash):'â€”';
      detailEl.textContent =
        `ID: ${c.charid}\nName: ${c.name}\nHealth: ${c.health||'-'}\nArmor: ${c.armor||'-'}\nCash: ${c.cash!=null?('$'+c.cash):'-'}`;
      renderGrid(get('azfw-search').value || '');
    }

    function openModal(m){ m.classList.add('visible'); m.setAttribute('aria-hidden','false'); }
    function closeModal(m){ m.classList.remove('visible'); m.setAttribute('aria-hidden','true'); }

    function showToast(msg, ttl=2200){
      const t=document.createElement('div');
      t.className='toast';
      t.textContent=msg;
      toastWrap.appendChild(t);
      setTimeout(()=>{t.style.opacity='0';t.style.transform='translateY(6px)';}, ttl-260);
      setTimeout(()=>t.remove(), ttl);
    }

    get('azfw-create').addEventListener('click', ()=>{
      pendingEditId=null;
      get('modal-create-title').textContent='Create Character';
      modalFirst.value='New'; modalLast.value='Citizen';
      openModal(modalCreate);
      setTimeout(()=>modalFirst.focus(),40);
    });

    get('azfw-edit').addEventListener('click', ()=>{
      if(!state.selectedId){ showToast('Select a character to edit'); return; }
      const c=state.characters.find(x=>x.charid===state.selectedId);
      pendingEditId=c.charid;
      get('modal-create-title').textContent='Edit Character';
      const parts=(c.name||'').split(' ');
      modalFirst.value=parts[0]||'';
      modalLast.value=parts.slice(1).join(' ')||'';
      openModal(modalCreate);
    });

    get('azfw-delete').addEventListener('click', ()=>{
      if(!state.selectedId){ showToast('Select a character to delete'); return; }
      pendingDeleteId=state.selectedId;
      const c=state.characters.find(x=>x.charid===state.selectedId);
      get('modal-delete-msg').textContent = `Delete "${(c&&c.name)||'Unknown'}" â€” this cannot be undone.`;
      openModal(modalDelete);
    });

    createCancelBtn.addEventListener('click', ()=>{ pendingEditId=null; closeModal(modalCreate); });
    deleteCancelBtn.addEventListener('click', ()=>{ pendingDeleteId=null; closeModal(modalDelete); });

    createSaveBtn.addEventListener('click', ()=>{
      const first=(modalFirst.value||'').trim();
      const last=(modalLast.value||'').trim();
      if(!first){ showToast('First name required'); modalFirst.focus(); return; }
      const payload={ first, last };
      if(pendingEditId) payload.editCharId=pendingEditId;
      postToLua('azfw_create_character', payload).then(()=> {
        showToast(pendingEditId?'Character updated':'Character created');
        pendingEditId=null;
        closeModal(modalCreate);
      }).catch(()=>showToast('Failed to save character'));
    });

    deleteConfirmBtn.addEventListener('click', ()=>{
      if(!pendingDeleteId){ closeModal(modalDelete); return; }
      postToLua('azfw_delete_character', { charid: pendingDeleteId }).then(()=>{
        showToast('Character deleted');
        pendingDeleteId=null;
        closeModal(modalDelete);
      }).catch(()=>showToast('Failed to delete character'));
    });

    get('azfw-search').addEventListener('input', e=>renderGrid(e.target.value));
    get('azfw-sort').addEventListener('click', ()=>{
      state.characters.sort((a,b)=>(b.name||'').localeCompare(a.name||''));
      renderGrid(get('azfw-search').value||'');
    });

    get('azfw-start').addEventListener('click', async ()=>{
      if(!state.selectedId){ showToast('Select a character'); return; }
      await postToLua('azfw_select_character', { charid: state.selectedId }).catch(()=>{});
      await postToLua('azfw_close_ui', {}).catch(()=>{});
      setTimeout(()=>postToLua('request_spawns', {}), 100);
    });

    get('azfw-open-spawn').addEventListener('click', async ()=>{
      await postToLua('azfw_close_ui', {}).catch(()=>{});
      setTimeout(()=>postToLua('request_spawns', {}), 100);
    });

    requestAnimationFrame(()=>bg.classList.add('azfw-appeared'));
  })();
  </script>

  <!-- SPAWN MODAL -->
  <div id="spawnModalBackdrop" class="spawn-modal-backdrop" aria-hidden="true">
    <div class="spawn-modal" role="dialog" aria-modal="true">
      <div class="spawn-left">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div style="font-weight:800;font-size:16px">Spawn Selector</div>
          <div style="display:flex;gap:8px">
            <button id="spawnRefreshBtn" class="btn-ghost">Refresh</button>
            <button id="spawnCloseBtnTop" class="btn-ghost">Close</button>
          </div>
        </div>

        <div class="spawn-map" id="spawnMap">
          <div class="zoom-controls">
            <button id="zoomInBtn" class="zoom-btn">+</button>
            <button id="zoomOutBtn" class="zoom-btn">âˆ’</button>
            <button id="zoomResetBtn" class="zoom-btn">Reset</button>
          </div>
          <div class="map-viewport">
            <div class="map-content" id="spawnMapContent">
              <img id="spawnMapImg" src="map.png" alt="map" draggable="false" />
            </div>
          </div>
        </div>

        <div style="display:flex;gap:8px;align-items:center;margin-top:8px">
          <div style="flex:1;color:var(--muted);font-size:13px" id="spawnHint">Select a spawn, then Spawn.</div>
          <div><button id="spawnSelectBtn" class="btn-primary">Spawn</button></div>
        </div>
      </div>

      <div class="spawn-right">
        <div style="font-weight:700">Spawns</div>
        <div class="spawn-list" id="spawnList"></div>
        <div class="spawn-controls" style="margin-top:8px">
          <button id="spawnEditorBtn" class="btn-ghost">Open Editor</button>
          <button id="spawnCenterBtn" class="btn-ghost">Center Map</button>
        </div>

        <div class="spawn-editor" id="spawnEditor">
          <input id="se_name" type="text" placeholder="Name" />
          <div style="display:flex;gap:8px">
            <input id="se_x" type="number" step="0.01" placeholder="Spawn X" />
            <input id="se_y" type="number" step="0.01" placeholder="Spawn Y" />
          </div>
          <div style="display:flex;gap:8px">
            <input id="se_z" type="number" step="0.01" placeholder="Spawn Z" />
            <input id="se_h" type="number" step="0.1" placeholder="Heading" />
          </div>
          <div style="display:flex;gap:8px;margin-top:6px">
            <input id="se_pin_x" type="number" step="0.01" placeholder="Pin X (map)" />
            <input id="se_pin_y" type="number" step="0.01" placeholder="Pin Y (map)" />
          </div>
          <input id="se_desc" type="text" placeholder="Description" />
          <div style="display:flex;gap:8px">
            <button id="se_placeBtn" class="btn-ghost">Place Pin by Click</button>
            <button id="se_copyCoordsBtn" class="btn-ghost">Copy Coords (XYZ)</button>
            <button id="se_saveBtn" class="btn-primary">Save</button>
            <button id="se_deleteBtn" class="btn btn-ghost">Delete</button>
            <button id="se_closeBtn" class="btn btn-ghost">Close Editor</button>
          </div>
        </div>
      </div>
    </div>
  </div>
<script>
(() => {
  const res = (typeof GetParentResourceName === "function") ? GetParentResourceName() : null;
  const post = (name, data) => {
    if (!res) return;
    fetch(`https://${res}/${name}`, {
      method: "POST",
      headers: {"Content-Type":"application/json; charset=UTF-8"},
      body: JSON.stringify(data || {})
    }).catch(() => {});
  };

  window.addEventListener("load", () => {
    post("azfw_nui_ready", {});
  });
})();
</script>

  <script>
  (function(){
    const backdrop = document.getElementById('spawnModalBackdrop');
    const spawnMap = document.getElementById('spawnMap');
    const mapViewport = spawnMap.querySelector('.map-viewport');
    const mapContent = document.getElementById('spawnMapContent');
    const spawnMapImg = document.getElementById('spawnMapImg');

    const spawnList = document.getElementById('spawnList');
    const spawnSelectBtn = document.getElementById('spawnSelectBtn');
    const spawnCloseBtnTop = document.getElementById('spawnCloseBtnTop');
    const spawnRefreshBtn = document.getElementById('spawnRefreshBtn');
    const spawnEditorBtn = document.getElementById('spawnEditorBtn');
    const spawnCenterBtn = document.getElementById('spawnCenterBtn');
    const zoomInBtn = document.getElementById('zoomInBtn');
    const zoomOutBtn = document.getElementById('zoomOutBtn');
    const zoomResetBtn = document.getElementById('zoomResetBtn');

    const spawnEditor = document.getElementById('spawnEditor');
    const se_name = document.getElementById('se_name');
    const se_x = document.getElementById('se_x');
    const se_y = document.getElementById('se_y');
    const se_z = document.getElementById('se_z');
    const se_h = document.getElementById('se_h');
    const se_desc = document.getElementById('se_desc');
    const se_pin_x = document.getElementById('se_pin_x');
    const se_pin_y = document.getElementById('se_pin_y');
    const se_placeBtn = document.getElementById('se_placeBtn');
    const se_copyCoordsBtn = document.getElementById('se_copyCoordsBtn');
    const se_saveBtn = document.getElementById('se_saveBtn');
    const se_deleteBtn = document.getElementById('se_deleteBtn');
    const se_closeBtn = document.getElementById('se_closeBtn');

    const toastWrap = document.getElementById('toastWrap');

    let SPAWNS = [];
    let MAP_BOUNDS = { minX:-3000, maxX:3000, minY:-6300, maxY:7000 };
    let RESOURCE_SPAWN = null;

    let selectedId = null;
    let editorOpen = false;
    let placingPinByClick = false;

    let scale = 1, translateX = 0, translateY = 0;
    const minScale=0.5, maxScale=4.0;
    let contentWidth=2048, contentHeight=2048;

    function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[c])); }
    function showToast(msg, ttl=2200){
      const t=document.createElement('div');
      t.className='toast';
      t.textContent=msg;
      toastWrap.appendChild(t);
      setTimeout(()=>{t.style.opacity='0';t.style.transform='translateY(6px)';}, ttl-260);
      setTimeout(()=>t.remove(), ttl);
    }

    function spawnFetch(endpoint, payload={}){
      if(!RESOURCE_SPAWN) return Promise.reject(new Error("no resource"));
      return fetch(`https://${RESOURCE_SPAWN}/${endpoint}`, {
        method:'POST',
        headers:{'Content-Type':'application/json; charset=UTF-8'},
        body: JSON.stringify(payload)
      }).then(r=>r.text().then(t=>{ try{return t?JSON.parse(t):null;}catch(e){return t||null;} }));
    }

    function worldToPixel(x, y, w, h) {
      const u = (x - MAP_BOUNDS.minX) / (MAP_BOUNDS.maxX - MAP_BOUNDS.minX);
      const v = (MAP_BOUNDS.maxY - y) / (MAP_BOUNDS.maxY - MAP_BOUNDS.minY);
      return { px: (u * w), py: (v * h) };
    }
    function pixelToWorld(px, py, w, h) {
      const u = px / w;
      const v = py / h;
      const x = MAP_BOUNDS.minX + u * (MAP_BOUNDS.maxX - MAP_BOUNDS.minX);
      const y = MAP_BOUNDS.maxY - v * (MAP_BOUNDS.maxY - MAP_BOUNDS.minY);
      return { x: parseFloat(x.toFixed(2)), y: parseFloat(y.toFixed(2)) };
    }

    function normalizeSpawns(arr){
      if(!Array.isArray(arr)) return [];
      return arr.map(s=>{
        const out = Object.assign({}, s);
        out.locked = !!out.locked; // IMPORTANT: preserve locked spawns (Last Location)
        if (out.spawn && out.spawn.coords) {
          out.coords = out.coords || { x: out.spawn.coords.x, y: out.spawn.coords.y, z: out.spawn.coords.z || 0 };
          out.heading = (out.heading !== undefined) ? out.heading : (out.spawn.heading !== undefined ? out.spawn.heading : 0);
        }
        if (!out.pin) {
          if (out.coords) out.pin = { x: out.coords.x, y: out.coords.y };
          else out.pin = { x: 0, y: 0 };
        }
        out.id = out.id || ('spawn_' + (Date.now() + Math.floor(Math.random()*999)));
        return out;
      });
    }

    function ensureMapContentReady(){
      return new Promise(resolve=>{
        if(spawnMapImg.complete && spawnMapImg.naturalWidth){
          contentWidth = spawnMapImg.naturalWidth || contentWidth;
          contentHeight = spawnMapImg.naturalHeight || contentHeight;
          mapContent.style.width = contentWidth + 'px';
          mapContent.style.height = contentHeight + 'px';
          resolve();
        }else{
          spawnMapImg.addEventListener('load', ()=>{
            contentWidth = spawnMapImg.naturalWidth || contentWidth;
            contentHeight = spawnMapImg.naturalHeight || contentHeight;
            mapContent.style.width = contentWidth + 'px';
            mapContent.style.height = contentHeight + 'px';
            resolve();
          }, {once:true});
          setTimeout(()=>resolve(), 600);
        }
      });
    }

    function applyTransform(){
      mapContent.style.transform = `translate(${translateX}px, ${translateY}px) scale(${scale})`;
    }

    function fitMapToViewport(){
      const r = mapViewport.getBoundingClientRect();
      const fit = Math.min(r.width/contentWidth, r.height/contentHeight, 1);
      scale = fit;
      translateX = (r.width - (contentWidth*scale))/2;
      translateY = (r.height - (contentHeight*scale))/2;
      applyTransform();
    }

    function clearPins(){
      mapContent.querySelectorAll('.spawn-pin').forEach(n=>n.remove());
    }

    function isSelectedLocked(){
      const s = SPAWNS.find(x=>x.id===selectedId);
      return !!(s && s.locked);
    }

    function renderPins(){
      clearPins();
      const w=contentWidth, h=contentHeight;
      SPAWNS.forEach(s=>{
        if(!s || !s.pin) return;
        const pos = worldToPixel(s.pin.x, s.pin.y, w, h);
        const d=document.createElement('div');
        d.className='spawn-pin';
        d.style.left = pos.px+'px';
        d.style.top = pos.py+'px';
        d.dataset.id = s.id;
        d.title = s.name || s.id;
        const dot=document.createElement('div'); dot.className='dot';
        d.appendChild(dot);
        d.addEventListener('click', (ev)=>{ ev.stopPropagation(); selectSpawn(s.id); });
        mapContent.appendChild(d);
      });
      mapContent.querySelectorAll('.spawn-pin').forEach(p=>p.classList.toggle('active', p.dataset.id===selectedId));
      addPinDragHandlers();
    }

    function populateList(){
      spawnList.innerHTML='';
      SPAWNS.forEach(s=>{
        const it=document.createElement('div');
        it.className='item' + (selectedId===s.id?' selected':'');
        const lock = s.locked ? ' ðŸ”’' : '';
        it.dataset.id=s.id;
        it.innerHTML = `
          <div style="font-weight:700">${escapeHtml((s.name||s.id) + lock)}</div>
          <div style="font-size:12px;color:var(--muted)">${escapeHtml(s.description||'')}</div>
        `;
        it.addEventListener('click', ()=>selectSpawn(s.id));
        spawnList.appendChild(it);
      });
      updateEditorButtonState();
    }

    function selectSpawn(id){
      selectedId = id;
      mapContent.querySelectorAll('.spawn-pin').forEach(p=>p.classList.toggle('active', p.dataset.id===id));
      spawnList.querySelectorAll('.item').forEach(i=>i.classList.toggle('selected', i.dataset.id===id));

      const found = SPAWNS.find(x=>x.id===id);
      if(editorOpen && found){
        if(found.locked){
          showToast("This spawn is locked (Last Location).");
          // keep fields blank while locked
          se_name.value=''; se_x.value=''; se_y.value=''; se_z.value=''; se_h.value=''; se_desc.value=''; se_pin_x.value=''; se_pin_y.value='';
        } else {
          const sx = (found.spawn && found.spawn.coords) ? found.spawn.coords.x : (found.coords?found.coords.x:0);
          const sy = (found.spawn && found.spawn.coords) ? found.spawn.coords.y : (found.coords?found.coords.y:0);
          const sz = (found.spawn && found.spawn.coords) ? found.spawn.coords.z : (found.coords?found.coords.z:0);
          const sh = (found.spawn && found.spawn.heading!=null) ? found.spawn.heading : (found.heading||0);
          se_name.value = found.name || '';
          se_x.value = sx||0; se_y.value = sy||0; se_z.value = sz||0; se_h.value = sh||0;
          se_desc.value = found.description || '';
          se_pin_x.value = (found.pin && found.pin.x!=null) ? found.pin.x : (sx||0);
          se_pin_y.value = (found.pin && found.pin.y!=null) ? found.pin.y : (sy||0);
        }
      }

      updateEditorButtonState();
    }

    function updateEditorButtonState(){
      if(!spawnEditorBtn) return;

      const locked = isSelectedLocked();
      if(SPAWNS.length===0){
        spawnEditorBtn.removeAttribute('disabled');
        spawnEditorBtn.title='Open editor to create the first spawn';
        return;
      }
      if(!selectedId){
        spawnEditorBtn.setAttribute('disabled','true');
        spawnEditorBtn.title='Select a spawn first';
        return;
      }
      if(locked){
        spawnEditorBtn.setAttribute('disabled','true');
        spawnEditorBtn.title='This spawn is locked';
        return;
      }
      spawnEditorBtn.removeAttribute('disabled');
      spawnEditorBtn.title='Edit selected spawn';
    }

    function openSpawnModal(){
      backdrop.classList.add('open');
      backdrop.setAttribute('aria-hidden','false');
      ensureMapContentReady().then(()=>{
        renderPins();
        populateList();
        fitMapToViewport();
      });
    }

    function closeSpawnModal(){
      backdrop.classList.remove('open');
      backdrop.setAttribute('aria-hidden','true');
      selectedId=null;
      editorOpen=false;
      spawnEditor.classList.remove('open');
      spawnEditorBtn.textContent='Open Editor';
      placingPinByClick=false;
      se_placeBtn.textContent='Place Pin by Click';
      spawnFetch('closeSpawnMenu', {}).catch(()=>{});
    }

    // Zoom + pan minimal
    function zoomAt(cx, cy, factor){
      const r=mapViewport.getBoundingClientRect();
      const px=cx-r.left, py=cy-r.top;
      const contentX=(px-translateX)/scale;
      const contentY=(py-translateY)/scale;
      const ns=Math.min(maxScale, Math.max(minScale, scale*factor));
      translateX = px - contentX*ns;
      translateY = py - contentY*ns;
      scale = ns;
      applyTransform();
    }

    mapViewport.addEventListener('wheel', (ev)=>{
      ev.preventDefault();
      zoomAt(ev.clientX, ev.clientY, ev.deltaY>0?0.92:1.08);
    }, {passive:false});

    zoomInBtn.addEventListener('click', ()=>{
      const r=mapViewport.getBoundingClientRect();
      zoomAt(r.left+r.width/2, r.top+r.height/2, 1.2);
    });
    zoomOutBtn.addEventListener('click', ()=>{
      const r=mapViewport.getBoundingClientRect();
      zoomAt(r.left+r.width/2, r.top+r.height/2, 0.8);
    });
    zoomResetBtn.addEventListener('click', ()=>fitMapToViewport());
    spawnCenterBtn.addEventListener('click', ()=>fitMapToViewport());

    // Editor toggle (deny locked spawn)
    spawnEditorBtn.addEventListener('click', async ()=>{
      if(!editorOpen){
        if(!selectedId){ showToast("Select a spawn first"); return; }
        if(isSelectedLocked()){ showToast("Locked spawn cannot be edited"); return; }
        try { await spawnFetch('request_edit_permission', {}); } catch(e){}
        editorOpen=true;
        spawnEditor.classList.add('open');
        spawnEditorBtn.textContent='Exit Editor';
        selectSpawn(selectedId);
      } else {
        editorOpen=false;
        spawnEditor.classList.remove('open');
        spawnEditorBtn.textContent='Open Editor';
      }
    });

    se_closeBtn.addEventListener('click', ()=>{
      editorOpen=false;
      spawnEditor.classList.remove('open');
      spawnEditorBtn.textContent='Open Editor';
    });

    // Place pin mode (deny locked)
    se_placeBtn.addEventListener('click', ()=>{
      if(isSelectedLocked()){ showToast("Locked spawn cannot be edited"); return; }
      placingPinByClick = !placingPinByClick;
      se_placeBtn.textContent = placingPinByClick ? "Click map to set PIN..." : "Place Pin by Click";
    });

    mapViewport.addEventListener('click', (ev)=>{
      if(ev.target.closest && ev.target.closest('.spawn-pin')) return;

      if(!placingPinByClick || !editorOpen) return;
      if(isSelectedLocked()){ showToast("Locked spawn cannot be edited"); placingPinByClick=false; se_placeBtn.textContent="Place Pin by Click"; return; }

      const r=mapViewport.getBoundingClientRect();
      const clickX=ev.clientX-r.left, clickY=ev.clientY-r.top;

      const contentX=(clickX-translateX)/scale;
      const contentY=(clickY-translateY)/scale;

      const coords = pixelToWorld(contentX, contentY, contentWidth, contentHeight);

      // Create new spawn at click
      const id='spawn_'+Date.now()+'_'+Math.floor(Math.random()*999);
      const zVal=parseFloat(se_z.value)||0;
      const hVal=parseFloat(se_h.value)||0;

      const newSpawn={
        id,
        name:'New Spawn',
        description:'',
        locked:false,
        spawn:{ coords:{x:coords.x,y:coords.y,z:zVal}, heading:hVal },
        coords:{x:coords.x,y:coords.y,z:zVal},
        heading:hVal,
        pin:{x:coords.x,y:coords.y}
      };

      SPAWNS.push(newSpawn);
      selectedId=id;
      placingPinByClick=false;
      se_placeBtn.textContent="Place Pin by Click";
      renderPins(); populateList(); selectSpawn(id);
    });

    // Save / delete (deny locked)
    se_saveBtn.addEventListener('click', async ()=>{
      if(isSelectedLocked()){ showToast("Locked spawn cannot be saved"); return; }

      const name=(se_name.value||'').trim() || ('spawn_'+Date.now());
      const x=parseFloat(se_x.value)||0;
      const y=parseFloat(se_y.value)||0;
      const z=parseFloat(se_z.value)||0;
      const h=parseFloat(se_h.value)||0;
      const desc=(se_desc.value||'').trim();
      const pinx=(se_pin_x.value!=='')?parseFloat(se_pin_x.value):x;
      const piny=(se_pin_y.value!=='')?parseFloat(se_pin_y.value):y;

      if(selectedId){
        const s=SPAWNS.find(v=>v.id===selectedId);
        if(s){
          s.name=name; s.description=desc;
          s.spawn={ coords:{x,y,z}, heading:h };
          s.coords={x,y,z}; s.heading=h;
          s.pin={x:pinx,y:piny};
        }
      } else {
        const id='spawn_'+Date.now();
        SPAWNS.push({id,name,description:desc,locked:false,spawn:{coords:{x,y,z},heading:h},coords:{x,y,z},heading:h,pin:{x:pinx,y:piny}});
        selectedId=id;
      }

      renderPins(); populateList(); selectSpawn(selectedId);
      try{ await spawnFetch('saveSpawns', { spawns: SPAWNS }); showToast("Spawns saved"); }catch(e){ showToast("Save failed"); }
    });

    se_deleteBtn.addEventListener('click', async ()=>{
      if(isSelectedLocked()){ showToast("Locked spawn cannot be deleted"); return; }
      if(!selectedId){ showToast("Select a spawn"); return; }
      SPAWNS = SPAWNS.filter(s=>s.id!==selectedId);
      selectedId=null;
      renderPins(); populateList();
      try{ await spawnFetch('saveSpawns', { spawns: SPAWNS }); showToast("Spawn deleted"); }catch(e){ showToast("Delete failed"); }
    });

    // Pin drag (deny locked)
    function addPinDragHandlers(){
      mapContent.querySelectorAll('.spawn-pin').forEach(pin=>{
        if(pin._hasDrag) return;
        pin._hasDrag=true;

        let dragging=false;
        let start={cx:0,cy:0,left:0,top:0, startPX:0, startPY:0};

        pin.addEventListener('mousedown', (ev)=>{
          if(!editorOpen) return;
          const id=pin.dataset.id;
          const s=SPAWNS.find(v=>v.id===id);
          if(s && s.locked) return;

          if(ev.button!==0) return;
          ev.stopPropagation();
          dragging=true;

          start.left=parseFloat(pin.style.left||0);
          start.top=parseFloat(pin.style.top||0);

          const r=mapViewport.getBoundingClientRect();
          const px=ev.clientX-r.left, py=ev.clientY-r.top;
          start.startPX=(px-translateX)/scale;
          start.startPY=(py-translateY)/scale;

          document.body.style.cursor='grabbing';
        });

        window.addEventListener('mousemove', (ev)=>{
          if(!dragging) return;
          ev.preventDefault();

          const r=mapViewport.getBoundingClientRect();
          const px=ev.clientX-r.left, py=ev.clientY-r.top;
          const cX=(px-translateX)/scale;
          const cY=(py-translateY)/scale;

          const dx=cX-start.startPX;
          const dy=cY-start.startPY;

          pin.style.left = (start.left + dx) + 'px';
          pin.style.top  = (start.top + dy) + 'px';
        });

        window.addEventListener('mouseup', ()=>{
          if(!dragging) return;
          dragging=false;
          document.body.style.cursor='';

          const id=pin.dataset.id;
          const s=SPAWNS.find(v=>v.id===id);
          if(!s || s.locked) return;

          const contentX=parseFloat(pin.style.left||0);
          const contentY=parseFloat(pin.style.top||0);
          const world=pixelToWorld(contentX, contentY, contentWidth, contentHeight);

          s.pin={x:world.x,y:world.y};
          se_pin_x.value=world.x;
          se_pin_y.value=world.y;

          renderPins(); populateList(); selectSpawn(id);
        });
      });
    }

    spawnSelectBtn.addEventListener('click', ()=>{
      if(!selectedId){ showToast("Select a spawn first"); return; }
      const s = SPAWNS.find(x=>x.id===selectedId);
      if(!s || !s.spawn || !s.spawn.coords){ showToast("Spawn not found"); return; }
      spawnFetch('selectSpawn', { spawn: s }).then(()=>closeSpawnModal()).catch(()=>closeSpawnModal());
    });

    spawnCloseBtnTop.addEventListener('click', ()=>closeSpawnModal());
    spawnRefreshBtn.addEventListener('click', ()=>spawnFetch('request_spawns', {}).catch(()=>showToast("Refresh failed")));

    backdrop.addEventListener('click', (ev)=>{ if(ev.target===backdrop) closeSpawnModal(); });

    window.addEventListener('message', (ev)=>{
      const d=ev.data||{};
      if(!d.type) return;
      if(d.type==='spawn_data'){
        SPAWNS = normalizeSpawns(d.spawns||[]);
        if(d.mapBounds) MAP_BOUNDS = Object.assign(MAP_BOUNDS, d.mapBounds);
        if(d.resourceName) RESOURCE_SPAWN = d.resourceName;
        openSpawnModal();
      } else if(d.type==='spawn_update'){
        SPAWNS = normalizeSpawns(d.spawns||SPAWNS);
        renderPins(); populateList();
      } else if(d.type==='saveResult'){
        if(d.ok) showToast("Spawns saved");
        else showToast("Save failed: " + (d.err||"unknown"));
      } else if(d.type==='adminCheckResult'){
        // handled by client permissions; we keep UI simple
      }
    });
  })();
  </script>
</body>
</html>
